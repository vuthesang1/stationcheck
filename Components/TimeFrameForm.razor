@using StationCheck.Models
@using StationCheck.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@using DevExpress.Blazor
@inject IMonitoringService MonitoringService
@inject IJSRuntime JS

@if (Visible)
{
    <DxPopup @bind-Visible="@Visible"
             HeaderText="@(TimeFrame.Id == Guid.Empty ? "➕ Thêm khung thời gian" : "✏️ Sửa khung thời gian")"
             ShowCloseButton="true"
             Width="600px"
             MaxWidth="95%"
             Height="auto"
             MaxHeight="90vh"
             CloseOnOutsideClick="false"
             CssClass="timeframe-form-popup">
        <BodyContentTemplate Context="popupContext">
        <EditForm Model="@TimeFrame" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            
            <!-- Scrollable Content -->
            <div class="p-3" style="max-height: calc(90vh - 150px); overflow-y: auto; overflow-x: hidden;">
                <!-- Name -->
                <div class="mb-3">
                    <label class="form-label">Tên khung thời gian <span class="text-danger">*</span></label>
                    <InputText @bind-Value="TimeFrame.Name" class="form-control" placeholder="Ví dụ: Giám sát chính, Giám sát dự phòng..." />
                    <ValidationMessage For="@(() => TimeFrame.Name)" />
                </div>

                <!-- Hidden Time Range (auto 00:00-24:00) -->
                <div class="alert alert-info py-2 mb-3">
                    <i class="fas fa-clock"></i> <strong>Thời gian giám sát:</strong> 00:00 - 24:00 (Cả ngày)
                </div>

                @if (IsDebugMode)
                {
                    <!-- Frequency Input (Minutes for testing) -->
                    <div class="mb-3">
                        <label class="form-label">Tần suất kiểm tra (phút) <span class="text-danger">*</span></label>
                        <input type="number" 
                               @bind="TimeFrame.FrequencyMinutes" 
                               @bind:after="OnFrequencyChanged"
                               class="form-control" 
                               min="1" 
                               max="1440"
                               placeholder="Nhập số phút (ví dụ: 60 = 1 giờ)" />
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i>
                            <strong>Chế độ testing:</strong> Nhập tần suất tính bằng phút (1-1440 phút). VD: 5 phút, 10 phút, 60 phút (1 giờ)
                        </small>
                    </div>
                }
                else
                {
                    <!-- Frequency Dropdown (1-7 hours for production) -->
                    <div class="mb-3">
                        <label class="form-label">Tần suất kiểm tra <span class="text-danger">*</span></label>
                        <select @bind="selectedFrequencyHours" @bind:after="OnFrequencyChanged" class="form-select">
                            <option value="1">1 giờ</option>
                            <option value="2">2 giờ</option>
                            <option value="3">3 giờ</option>
                            <option value="4">4 giờ</option>
                            <option value="5">5 giờ</option>
                            <option value="6">6 giờ</option>
                            <option value="7">7 giờ</option>
                        </select>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i>
                            Hệ thống sẽ kiểm tra mỗi @selectedFrequencyHours giờ (= @(selectedFrequencyHours * 60) phút)
                        </small>
                    </div>
                }

                <!-- Buffer time -->
                <div class="mb-3">
                    <label class="form-label">Thời gian buffer (phút) <span class="text-muted">(Tùy chọn)</span></label>
                    <input type="number" 
                           @bind="TimeFrame.BufferMinutes" 
                           class="form-control" 
                           min="0" 
                           max="@(TimeFrame.FrequencyMinutes > 0 ? TimeFrame.FrequencyMinutes - 1 : 60)"
                           placeholder="Nhập số phút buffer (mặc định: 0)" />
                    <small class="form-text text-muted">
                        <i class="fas fa-info-circle"></i>
                        <strong>Buffer là khoảng dung sai cho phép đến trễ (sau checkpoint).</strong><br/>
                        • Buffer phải nhỏ hơn tần suất (max: @(TimeFrame.FrequencyMinutes > 0 ? TimeFrame.FrequencyMinutes - 1 : 60) phút)<br/>
                        • VD 1: Tần suất 1 giờ, Buffer 15 phút → Checkpoint 10:00 sẽ chấp nhận đến từ 10:00 đến 10:15<br/>
                        • VD 2: Tần suất 2 giờ, Buffer 30 phút → Checkpoint 12:00 sẽ chấp nhận đến từ 12:00 đến 12:30<br/>
                        • <em>Để 0 nếu yêu cầu đến đúng giờ checkpoint</em>
                    </small>
                
                @if (nextRunTimes.Any())
                    {
                        <div class="alert alert-info py-2 mt-2 mb-0">
                            <i class="fas fa-clock"></i> <strong>3 lần chạy tiếp theo:</strong>
                            <ul class="mb-0 mt-1 ps-3">
                                @foreach (var runTime in nextRunTimes)
                                {
                                    <li>@runTime</li>
                                }
                            </ul>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(frequencyError))
                    {
                        <div class="text-danger small mt-1">
                            <i class="fas fa-exclamation-circle"></i> @frequencyError
                        </div>
                    }
                </div>

                <!-- Days of Week (Hidden - Auto All Days) -->
                <div class="alert alert-success py-2 mb-3">
                    <i class="fas fa-calendar-week"></i> <strong>Ngày áp dụng:</strong> Tất cả các ngày trong tuần (24/7)
                </div>

                <!-- Is Enabled -->
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="isEnabled" @bind="TimeFrame.IsEnabled" />
                        <label class="form-check-label" for="isEnabled">Kích hoạt ngay</label>
                    </div>
                </div>
            </div>

            <!-- Fixed Footer Buttons -->
            <div class="border-top p-3 bg-light d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" @onclick="Cancel">
                    <i class="fas fa-times"></i> Hủy
                </button>
                <button type="submit" class="btn btn-primary" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="fas fa-save"></i> @(TimeFrame.Id == Guid.Empty ? "Thêm" : "Cập nhật")
                </button>
            </div>
        </EditForm>
    </BodyContentTemplate>
</DxPopup>
}

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }
    [Parameter] public Guid StationId { get; set; }
    [Parameter] public TimeFrame TimeFrame { get; set; } = new();
    [Parameter] public EventCallback OnSaved { get; set; }

    private bool isSaving = false;
    private bool isInitialized = false;
    private int selectedFrequencyHours = 1;
    private List<int> frequencyOptions = new();
    private string timeRangeError = string.Empty;
    private string frequencyError = string.Empty;
    private List<string> nextRunTimes = new();

#if DEBUG
    private bool IsDebugMode => true;
#else
    private bool IsDebugMode => false;
#endif

    // Day checkboxes
    private bool day1, day2, day3, day4, day5, day6, day7;

    // Time inputs (string binding for HTML time input)
    private string startTimeInput = "09:00";
    private string endTimeInput = "17:00";

    protected override void OnParametersSet()
    {
        if (Visible)
        {
            // Always set 24/7 mode
            startTimeInput = "00:00";
            endTimeInput = "23:59";
            
            // All days selected (24/7)
            day1 = day2 = day3 = day4 = day5 = day6 = day7 = true;
            
            if (TimeFrame.Id != Guid.Empty)
            {
                // Edit mode - populate from existing
                if (!IsDebugMode)
                {
                    // In Release mode, convert FrequencyMinutes to hours for dropdown
                    selectedFrequencyHours = TimeFrame.FrequencyMinutes / 60;
                    if (selectedFrequencyHours < 1) selectedFrequencyHours = 1;
                    if (selectedFrequencyHours > 7) selectedFrequencyHours = 7;
                }
                isInitialized = true;
            }
            else if (!isInitialized)
            {
                // Add mode - defaults (only set once on first open)
                TimeFrame.IsEnabled = true;
                if (IsDebugMode)
                {
                    TimeFrame.FrequencyMinutes = 60; // Default 1 hour for testing
                }
                else
                {
                    selectedFrequencyHours = 1; // Default 1 hour for production
                    TimeFrame.FrequencyMinutes = 60;
                }
                isInitialized = true;
            }

            CalculateMaxFrequency();
        }
        else
        {
            // Reset when modal closes
            isInitialized = false;
        }
    }

    private void CalculateMaxFrequency()
    {
        timeRangeError = string.Empty;
        frequencyOptions.Clear();
        frequencyError = string.Empty;
        
        // Generate frequency options (1-7 hours only)
        for (int i = 1; i <= 7; i++)
        {
            frequencyOptions.Add(i);
        }
        
        // Ensure selected value is within 1-7 hours
        if (selectedFrequencyHours < 1) selectedFrequencyHours = 1;
        if (selectedFrequencyHours > 7) selectedFrequencyHours = 7;
        
        // Calculate next run
        CalculateNextRun();
    }

    private void CalculateNextRun()
    {
        nextRunTimes.Clear();
        
        if (TimeFrame.FrequencyMinutes <= 0)
        {
            return;
        }
        
        // Use local time (UTC+7)
        var now = DateTime.Now;
        var start = TimeSpan.Zero; // 00:00
        var end = TimeSpan.FromHours(24); // 24:00
        
        // All days (24/7)
        var selectedDays = new List<int> { 1, 2, 3, 4, 5, 6, 7 };
        
        var frequencySpan = TimeSpan.FromMinutes(TimeFrame.FrequencyMinutes);
        var foundRuns = new List<DateTime>();
        
        // Search for next 3 runs within next 2 days
        for (int dayOffset = 0; dayOffset < 2 && foundRuns.Count < 3; dayOffset++)
        {
            var checkDate = now.Date.AddDays(dayOffset);
            
            // Calculate all possible run times for this day
            // Start from 00:00, increment by frequency
            var currentRunTime = start;
            while (currentRunTime < end && foundRuns.Count < 3)
            {
                var fullDateTime = checkDate.Add(currentRunTime);
                
                // Only include runs that are in the future
                if (fullDateTime > now)
                {
                    foundRuns.Add(fullDateTime);
                }
                
                currentRunTime = currentRunTime.Add(frequencySpan);
            }
        }
        // Format the messages
        foreach (var runTime in foundRuns)
        {
            var vietnameseDayOfWeek = runTime.DayOfWeek switch
            {
                DayOfWeek.Monday => "Thứ 2",
                DayOfWeek.Tuesday => "Thứ 3",
                DayOfWeek.Wednesday => "Thứ 4",
                DayOfWeek.Thursday => "Thứ 5",
                DayOfWeek.Friday => "Thứ 6",
                DayOfWeek.Saturday => "Thứ 7",
                DayOfWeek.Sunday => "Chủ nhật",
                _ => ""
            };
            
            string message;
            if (runTime.Date == now.Date)
            {
                message = $"{runTime:HH:mm} hôm nay";
            }
            else if (runTime.Date == now.Date.AddDays(1))
            {
                message = $"{runTime:HH:mm} ngày mai ({vietnameseDayOfWeek}, {runTime:dd/MM/yyyy})";
            }
            else
            {
                message = $"{runTime:HH:mm} - {vietnameseDayOfWeek}, {runTime:dd/MM/yyyy}";
            }
            
            nextRunTimes.Add(message);
        }
    }

    private List<int> GetSelectedDays()
    {
        var days = new List<int>();
        if (day1) days.Add(1);
        if (day2) days.Add(2);
        if (day3) days.Add(3);
        if (day4) days.Add(4);
        if (day5) days.Add(5);
        if (day6) days.Add(6);
        if (day7) days.Add(7);
        return days;
    }

    private void ParseDaysOfWeek(string? daysOfWeek)
    {
        if (string.IsNullOrEmpty(daysOfWeek))
        {
            day1 = day2 = day3 = day4 = day5 = day6 = day7 = true;
            return;
        }

        if (daysOfWeek.Contains(","))
        {
            var days = daysOfWeek.Split(',').Select(int.Parse).ToHashSet();
            day1 = days.Contains(1);
            day2 = days.Contains(2);
            day3 = days.Contains(3);
            day4 = days.Contains(4);
            day5 = days.Contains(5);
            day6 = days.Contains(6);
            day7 = days.Contains(7);
        }
        else
        {
            // Bitmask format
            int bitmask = int.Parse(daysOfWeek);
            day1 = (bitmask & 1) != 0;
            day2 = (bitmask & 2) != 0;
            day3 = (bitmask & 4) != 0;
            day4 = (bitmask & 8) != 0;
            day5 = (bitmask & 16) != 0;
            day6 = (bitmask & 32) != 0;
            day7 = (bitmask & 64) != 0;
        }
    }

    private string GetDaysOfWeekString()
    {
        // Always return all days (24/7)
        return "1,2,3,4,5,6,7";
    }

    private async Task HandleSubmit()
    {
        // Validate before submit
        if (!string.IsNullOrEmpty(timeRangeError))
        {
            await JS.InvokeVoidAsync("alert", timeRangeError);
            return;
        }
        
        if (!string.IsNullOrEmpty(frequencyError))
        {
            await JS.InvokeVoidAsync("alert", frequencyError);
            return;
        }
        
        isSaving = true;
        try
        {
            // Parse time inputs
            if (!TimeSpan.TryParse(startTimeInput, out var parsedStart))
            {
                await JS.InvokeVoidAsync("alert", "Thời gian bắt đầu không hợp lệ!");
                return;
            }
            
            if (!TimeSpan.TryParse(endTimeInput, out var parsedEnd))
            {
                await JS.InvokeVoidAsync("alert", "Thời gian kết thúc không hợp lệ!");
                return;
            }
            
            // Validate EndTime > StartTime
            if (parsedEnd <= parsedStart)
            {
                await JS.InvokeVoidAsync("alert", "Thời gian kết thúc phải lớn hơn thời gian bắt đầu!");
                return;
            }
            
            // Always set to 24/7 mode (00:00 - 23:59)
            TimeFrame.StartTime = TimeSpan.Zero; // 00:00
            TimeFrame.EndTime = new TimeSpan(23, 59, 59); // 23:59:59 (SQL Server time max)
            TimeFrame.DaysOfWeek = "1,2,3,4,5,6,7"; // All days
            
            // FrequencyMinutes is already set from input binding, no conversion needed

            // Client-side validation (1 minute to 24 hours)
            if (TimeFrame.FrequencyMinutes < 1 || TimeFrame.FrequencyMinutes > 1440)
            {
                await JS.InvokeVoidAsync("alert", "Tần suất phải từ 1 phút đến 1440 phút (24 giờ)!");
                return;
            }

            // Validate buffer is less than frequency
            if (TimeFrame.BufferMinutes >= TimeFrame.FrequencyMinutes)
            {
                await JS.InvokeVoidAsync("alert", $"Buffer ({TimeFrame.BufferMinutes} phút) phải nhỏ hơn tần suất ({TimeFrame.FrequencyMinutes} phút)!");
                return;
            }

            if (TimeFrame.Id == Guid.Empty)
            {
                // Create new
                await MonitoringService.CreateTimeFrameForStationAsync(StationId, TimeFrame);
            }
            else
            {
                // Update existing
                await MonitoringService.UpdateTimeFrameAsync(TimeFrame);
            }

            await OnSaved.InvokeAsync();
            await VisibleChanged.InvokeAsync(false);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task Cancel()
    {
        await VisibleChanged.InvokeAsync(false);
    }
    
    private void OnFrequencyChanged()
    {
        if (!IsDebugMode)
        {
            // In Release mode, convert hours to minutes
            TimeFrame.FrequencyMinutes = selectedFrequencyHours * 60;
        }
        // Recalculate next run times
        CalculateNextRun();
    }
}

<style>
    /* Force TimeFrameForm popup to be on top with inline styles */
    .timeframe-form-popup {
        z-index: 10000 !important;
        position: relative !important;
    }
    
    /* Target DevExpress generated backdrop - appears as sibling */
    body > .dxbl-popup-backdrop:last-of-type {
        z-index: 9999 !important;
    }
</style>
