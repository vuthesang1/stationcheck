@using StationCheck.Models
@using StationCheck.Interfaces
@using StationCheck.Data
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using DevExpress.Blazor
@using DevExpress.Data
@using Microsoft.AspNetCore.Components.Authorization
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@implements IDisposable

<div class="station-status-panel @(isFullscreen ? "fullscreen-mode" : "")">
    <div class="panel-header">
        <h4><i class="bi bi-broadcast"></i> Trạng thái trạm theo thời gian thực</h4>
        <div>
            <button class="btn btn-sm btn-secondary me-2" @onclick="ToggleFullscreen">
                <i class="bi bi-@(isFullscreen ? "fullscreen-exit" : "arrows-fullscreen")"></i>
                @(isFullscreen ? "Exit Fullscreen" : "Fullscreen")
            </button>
            <button class="btn btn-sm btn-primary" @onclick="LoadStations">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (stations.Count == 0)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Chưa có trạm nào được cấu hình.
        </div>
    }
    else
    {
        <div class="stations-grid">
            @foreach (var station in stations)
            {
                var status = GetStationStatus(station);
                <div class="station-card @GetStatusClass(status)" @onclick="() => ShowStationDetails(station)">
                    <div class="station-compact">
                        <span class="status-indicator @GetStatusIndicatorClass(status)"></span>
                        <span class="station-name-compact">@station.Name</span>
                    </div>
                </div>
            }
        </div>
    }

    <div class="panel-footer">
        <div class="legend">
            <span class="legend-item">
                <span class="status-indicator status-normal"></span> Bình thường
            </span>
            <span class="legend-item">
                <span class="status-indicator status-alert"></span> Cảnh báo
            </span>
            <span class="legend-item">
                <span class="status-indicator status-paused"></span> Tạm ngưng
            </span>
        </div>
        <small class="text-muted">
            Last updated: @lastUpdateTime.ToLocalTime().ToString("HH:mm:ss")
        </small>
    </div>
</div>

@* Station Details Modal *@
@if (showStationModal && selectedStation != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" @onclick="CloseStationModal">
        <div class="modal-dialog modal-xl" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-building"></i> Chi tiết trạm: @selectedStation.Name
                    </h5>
                    <button type="button" class="close" @onclick="CloseStationModal" @onclick:stopPropagation="true"></button>
                </div>
                <div class="modal-body">
                    @if (isLoadingStationDetails)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Đang tải dữ liệu...</span>
                            </div>
                            <p class="mt-3 text-muted">Đang tải dữ liệu trạm...</p>
                        </div>
                    }
                    else
                    {
                        <ul class="nav nav-tabs mb-3" role="tablist">
                            @if (!isStationEmployeeRole)
                            {
                                <li class="nav-item">
                                    <button class="nav-link @(activeTab == "motion" ? "active" : "")" 
                                            @onclick="SwitchToMotionTab">
                                        <i class="bi bi-activity"></i> Lịch sử nhấn nút
                                    </button>
                                </li>
                            }
                            <li class="nav-item">
                                <button class="nav-link @(activeTab == "alerts" ? "active" : "")" 
                                        @onclick="SwitchToAlertsTab">
                                    <i class="bi bi-exclamation-triangle"></i> Cảnh báo
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link @(activeTab == "config-history" ? "active" : "")" 
                                        @onclick="SwitchToConfigTab">
                                    <i class="bi bi-clock-history"></i> Lịch sử cấu hình
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content">
                        @if (activeTab == "motion" && !isStationEmployeeRole)
                        {
                            <div class="motion-history">
                                <h6 class="mb-3">Lịch sử nhấn nút</h6>
                                
                                @if (motionHistory == null || !motionHistory.Any())
                                {
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i> Chưa có dữ liệu nhấn nút.
                                    </div>
                                }
                                else
                                {
                                    <div class="mb-3">
                                        <small class="text-muted">
                                            Tổng số @motionHistory.Count sự kiện
                                        </small>
                                    </div>
                                    
                                    <DxGrid Data="@motionHistory"
                                            PageSize="20"
                                            ShowPager="true"
                                            PagerNavigationMode="PagerNavigationMode.InputBox"
                                            PageSizeSelectorVisible="true"
                                            PageSizeSelectorItems="@(new int[] { 10, 20, 50, 100 })"
                                            AllowSelectRowByClick="false"
                                            HighlightRowOnHover="true"
                                            FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
                                            SizeMode="SizeMode.Small">
                                        <Columns>
                                            <DxGridDataColumn FieldName="DetectedAt" Caption="Thời gian phát hiện" Width="180px" DisplayFormat="dd/MM/yyyy HH:mm:ss">
                                             <CellDisplayTemplate>
                                                    @{
                                                        var motion = (MotionEvent)context.DataItem;
                                                    }
                                                    <span>@motion.DetectedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")</span>
                                                </CellDisplayTemplate>
                                            </DxGridDataColumn>

                                            
                                            <DxGridDataColumn FieldName="EventType" Caption="Loại sự kiện" Width="150px">
                                                <CellDisplayTemplate>
                                                    @{
                                                        var motion = (MotionEvent)context.DataItem;
                                                    }
                                                    @if (!string.IsNullOrEmpty(motion.EventType))
                                                    {
                                                        <span>@(motion.EventType == "Motion" ? "Nhấn nút" : motion.EventType)</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">N/A</span>
                                                    }
                                                </CellDisplayTemplate>
                                            </DxGridDataColumn>

                                            <DxGridDataColumn FieldName="CameraName" Caption="Ghi nhận" />
                                            
                                            <DxGridDataColumn FieldName="IsProcessed" Caption="Đã xử lý" Width="100px">
                                                <CellDisplayTemplate>
                                                    @{
                                                        var motion = (MotionEvent)context.DataItem;
                                                    }
                                                    @if (motion.IsProcessed)
                                                    {
                                                        <span class="badge bg-success">Đã xử lý</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-warning text-dark">Cảnh báo</span>
                                                    }
                                                </CellDisplayTemplate>
                                            </DxGridDataColumn>

                                            <DxGridDataColumn FieldName="Id" Caption="Thao tác" Width="100px" AllowSort="false">
                                                <CellDisplayTemplate>
                                                    @{
                                                        var motion = (MotionEvent)context.DataItem;
                                                    }
                                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => ShowMotionDetail(motion)">
                                                        <i class="bi bi-eye"></i> Xem
                                                    </button>
                                                </CellDisplayTemplate>
                                            </DxGridDataColumn>
                                        </Columns>
                                    </DxGrid>
                                }
                            </div>
                        }
                        else if (activeTab == "alerts")
                        {
                            <div class="alerts-history">
                                <h6 class="mb-3">Lịch sử cảnh báo (30 ngày gần nhất)</h6>
                                
                                @if (alertHistory == null || !alertHistory.Any())
                                {
                                    <div class="alert alert-success">
                                        <i class="bi bi-check-circle"></i> Không có cảnh báo nào.
                                    </div>
                                }
                                else
                                {
                                    @* Only display alerts that are not deleted and not resolved (actual warnings) *@
                                    @foreach (var alert in alertHistory.Where(a => !a.IsDeleted && !a.IsResolved))
                                    {
                                        <div class="alert-card mb-3 border rounded">
                                            <div class="d-flex justify-content-between align-items-start p-3">
                                                <div class="flex-grow-1">
                                                    <div class="d-flex align-items-center gap-2 mb-2">
                                                        <span class="badge @(alert.IsResolved ? "bg-secondary" : "bg-danger")">
                                                            @(alert.IsResolved ? "Đã xử lý" : "Cảnh báo")
                                                        </span>
                                                        <span class="badge bg-warning text-dark">@alert.Severity</span>
                                                        <small class="text-muted">@alert.AlertTime.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")</small>
                                                    </div>
                                                    <div class="mb-2">
                                                        <strong>@alert.Message</strong>
                                                    </div>
                                                    @if (alert.TimeFrame != null)
                                                    {
                                                        <div class="text-muted small">
                                                            <strong>@alert.TimeFrame.Name</strong> - 
                                                            Tần suất: @alert.TimeFrame.FrequencyMinutes phút - 
                                                            Buffer: +@alert.TimeFrame.BufferMinutes phút
                                                        </div>
                                                    }
                                                    @if (alert.IsResolved && alert.ResolvedAt.HasValue)
                                                    {
                                                        <div class="text-success small mt-2">
                                                            <i class="bi bi-check-circle"></i> 
                                                            @alert.ResolvedAt.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")
                                                            @if (!string.IsNullOrEmpty(alert.ResolvedBy))
                                                            {
                                                                <text> - @alert.ResolvedBy</text>
                                                            }
                                                            @if (!string.IsNullOrEmpty(alert.Notes))
                                                            {
                                                                <div class="mt-1 fst-italic">
                                                                    <i class="bi bi-chat-left-text"></i> @alert.Notes
                                                                </div>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                                <div class="d-flex gap-1">
                                                    @if (alert.TimeFrameHistoryId.HasValue && alert.TimeFrameHistorySnapshot != null)
                                                    {
                                                        <button class="btn btn-sm btn-outline-info" 
                                                                @onclick="() => ToggleConfigSnapshot(alert.Id)">
                                                            <i class="bi bi-@(expandedSnapshots.Contains(alert.Id) ? "eye-slash" : "eye")"></i>
                                                            @(expandedSnapshots.Contains(alert.Id) ? "Ẩn" : "Xem")
                                                        </button>
                                                    }
                                                    @* Temporarily hidden - Resolve button
                                                    @if (!alert.IsResolved)
                                                    {
                                                        <button class="btn btn-sm btn-success" 
                                                                @onclick="() => ShowResolveModal(alert.Id)"
                                                                title="Đánh dấu đã xử lý">
                                                            <i class="bi bi-check-circle"></i> Resolve
                                                        </button>
                                                    }
                                                    *@
                                                </div>
                                            </div>
                                            
                                            @* Config Snapshot displayed right below this alert *@
                                            @if (expandedSnapshots.Contains(alert.Id) && alert.TimeFrameHistorySnapshot != null)
                                            {
                                                <div class="border-top p-3 bg-light">
                                                    <h6 class="mb-2">
                                                        <i class="bi bi-file-earmark-code"></i> 
                                                        Snapshot cấu hình (Version @alert.TimeFrameHistorySnapshot.Version)
                                                    </h6>
                                                    <div class="row g-2">
                                                        @{
                                                            var config = ParseConfigSnapshot(alert.TimeFrameHistorySnapshot.ConfigurationSnapshot);
                                                        }
                                                        @if (config != null)
                                                        {
                                                            <div class="col-md-6">
                                                                <div class="card">
                                                                    <div class="card-body">
                                                                        <h6 class="card-subtitle mb-2 text-muted">Thông tin cơ bản</h6>
                                                                        <table class="table table-sm table-borderless mb-0">
                                                                            <tbody>
                                                                                <tr>
                                                                                    <td class="text-muted">Tên:</td>
                                                                                    <td><strong>@config.GetValueOrDefault("Name", "N/A")</strong></td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td class="text-muted">Trạng thái:</td>
                                                                                    <td>
                                                                                        @if (config.GetValueOrDefault("IsEnabled", "false") == "true")
                                                                                        {
                                                                                            <span class="badge bg-success">Đang bật</span>
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            <span class="badge bg-secondary">Đã tắt</span>
                                                                                        }
                                                                                    </td>
                                                                                </tr>
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="card">
                                                                    <div class="card-body">
                                                                        <h6 class="card-subtitle mb-2 text-muted">Cài đặt giám sát</h6>
                                                                        <table class="table table-sm table-borderless mb-0">
                                                                            <tbody>
                                                                                <tr>
                                                                                    <td class="text-muted">Khung giờ:</td>
                                                                                    <td><strong>@FormatTimeSpan(config.GetValueOrDefault("StartTime", "N/A")) - @FormatTimeSpan(config.GetValueOrDefault("EndTime", "N/A"))</strong></td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td class="text-muted">Tần suất:</td>
                                                                                    <td><strong>@config.GetValueOrDefault("FrequencyMinutes", "N/A") phút</strong></td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td class="text-muted">Buffer:</td>
                                                                                    <td><strong>+@config.GetValueOrDefault("BufferMinutes", "N/A") phút</strong></td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td class="text-muted">Ngày áp dụng:</td>
                                                                                    <td>@config.GetValueOrDefault("DaysOfWeek", "N/A")</td>
                                                                                </tr>
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-12">
                                                                <div class="card">
                                                                    <div class="card-body">
                                                                        <h6 class="card-subtitle mb-2 text-muted">Thông tin theo dõi</h6>
                                                                        <table class="table table-sm table-borderless mb-0">
                                                                            <tbody>
                                                                                <tr>
                                                                                    <td class="text-muted" style="width: 150px;">Ngày tạo:</td>
                                                                                    <td>@FormatDateTimeFromConfig(config.GetValueOrDefault("CreatedAt", "N/A"))</td>
                                                                                    <td class="text-muted" style="width: 150px;">Người tạo:</td>
                                                                                    <td>@config.GetValueOrDefault("CreatedBy", "N/A")</td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td class="text-muted">Ngày cập nhật:</td>
                                                                                    <td>@FormatDateTimeFromConfig(config.GetValueOrDefault("ModifiedAt", "N/A"))</td>
                                                                                    <td class="text-muted">Người cập nhật:</td>
                                                                                    <td>@config.GetValueOrDefault("ModifiedBy", "N/A")</td>
                                                                                </tr>
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="col-12">
                                                                <pre class="bg-dark text-light p-3" style="max-height: 300px; overflow-y: auto; font-size: 11px;">@alert.TimeFrameHistorySnapshot.ConfigurationSnapshot</pre>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                        }
                        else if (activeTab == "config-history")
                        {
                            <div class="config-history">
                                <h6 class="mb-3">Lịch sử thay đổi cấu hình (90 ngày gần nhất)</h6>
                                
                                @if (configHistory == null || !configHistory.Any())
                                {
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i> Chưa có lịch sử thay đổi nào.
                                    </div>
                                }
                                else
                                {
                                    <DxGrid Data="@configHistory"
                                            PageSize="10"
                                            ShowPager="true"
                                            PagerNavigationMode="PagerNavigationMode.InputBox"
                                            PageSizeSelectorVisible="true"
                                            AllowSelectRowByClick="true"
                                            HighlightRowOnHover="true"
                                            FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
                                            SizeMode="SizeMode.Small">
                                        <Columns>
                                            <DxGridDataColumn FieldName="ChangedAt" Caption="Thời gian" Width="160px" DisplayFormat="dd/MM/yyyy HH:mm:ss" />
                                            
                                            <DxGridDataColumn FieldName="EntityType" Caption="Loại" Width="120px">
                                                <CellDisplayTemplate>
                                                    @{
                                                        var log = (ConfigurationAuditLog)context.DataItem;
                                                    }
                                                    <span class="badge bg-info">@log.EntityType</span>
                                                </CellDisplayTemplate>
                                            </DxGridDataColumn>

                                            <DxGridDataColumn FieldName="EntityName" Caption="Tên" Width="180px" />

                                            <DxGridDataColumn FieldName="ActionType" Caption="Hành động" Width="110px">
                                                <CellDisplayTemplate>
                                                    @{
                                                        var log = (ConfigurationAuditLog)context.DataItem;
                                                        var badgeClass = log.ActionType switch
                                                        {
                                                            "Create" => "bg-success",
                                                            "Update" => "bg-warning text-dark",
                                                            "Delete" => "bg-danger",
                                                            _ => "bg-secondary"
                                                        };
                                                    }
                                                    <span class="badge @badgeClass">@log.ActionType</span>
                                                </CellDisplayTemplate>
                                            </DxGridDataColumn>

                                            <DxGridDataColumn FieldName="Changes" Caption="Thay đổi" MinWidth="250">
                                                <CellDisplayTemplate>
                                                    @{
                                                        var log = (ConfigurationAuditLog)context.DataItem;
                                                        var shortChanges = log.Changes?.Length > 100 ? log.Changes.Substring(0, 100) + "..." : log.Changes;
                                                    }
                                                    <span>@shortChanges</span>
                                                </CellDisplayTemplate>
                                            </DxGridDataColumn>

                                            <DxGridDataColumn FieldName="ChangedBy" Caption="Người thực hiện" Width="130px" />

                                            <DxGridDataColumn FieldName="Id" Caption="Thao tác" Width="100px" AllowSort="false">
                                                <CellDisplayTemplate>
                                                    @{
                                                        var log = (ConfigurationAuditLog)context.DataItem;
                                                    }
                                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => ShowConfigDetailModal(log)">
                                                        <i class="bi bi-eye"></i> Chi tiết
                                                    </button>
                                                </CellDisplayTemplate>
                                            </DxGridDataColumn>
                                        </Columns>
                                    </DxGrid>
                                }
                            </div>
                        }
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseStationModal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
}

@* Motion Detail Modal *@
@if (showMotionDetailModal && selectedMotionEvent != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.7);" @onclick="CloseMotionDetailModal">
        <div class="modal-dialog modal-lg" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-activity"></i> Chi tiết sự kiện nhấn nút
                    </h5>
                    <button type="button" class="close text-white" @onclick="CloseMotionDetailModal" @onclick:stopPropagation="true">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <strong>Thông tin cơ bản</strong>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless mb-0">
                                        <tbody>
                                            <tr>
                                                <td class="text-muted">Thời gian phát hiện:</td>
                                                <td><strong>@selectedMotionEvent.DetectedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")</strong></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Loại sự kiện:</td>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(selectedMotionEvent.EventType))
                                                    {
                                                        <span class="badge bg-info">@selectedMotionEvent.EventType</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">N/A</span>
                                                    }
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Đã xử lý:</td>
                                                <td>
                                                    @if (selectedMotionEvent.IsProcessed)
                                                    {
                                                        <span class="badge bg-success">Đã xử lý</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-warning text-dark">Cảnh báo</span>
                                                    }
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <strong>Nguồn dữ liệu</strong>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless mb-0">
                                        <tbody>
                                            <tr>
                                                <td class="text-muted">Email Subject:</td>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(selectedMotionEvent.EmailSubject))
                                                    {
                                                        <span>@selectedMotionEvent.EmailSubject</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">N/A</span>
                                                    }
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(selectedMotionEvent.EmailBody))
                        {
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <strong>Nội dung email</strong>
                                    </div>
                                    <div class="card-body">
                                        <pre class="bg-dark text-light p-3 mb-0" style="max-height: 400px; overflow-y: auto; font-size: 12px; white-space: pre-wrap; word-wrap: break-word;">@selectedMotionEvent.EmailBody</pre>
                                    </div>
                                </div>
                            </div>
                        }
                        else if (!string.IsNullOrEmpty(selectedMotionEvent.Payload))
                        {
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <strong>Payload / Dữ liệu bổ sung</strong>
                                    </div>
                                    <div class="card-body">
                                        @{
                                            var payloadData = ParsePayload(selectedMotionEvent.Payload);
                                        }
                                        @if (payloadData != null && payloadData.Any())
                                        {
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th style="width: 30%;">Thuộc tính</th>
                                                        <th>Giá trị</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var kvp in payloadData)
                                                    {
                                                        <tr>
                                                            <td class="text-muted"><strong>@kvp.Key</strong></td>
                                                            <td><code>@kvp.Value</code></td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        }
                                        else
                                        {
                                            <pre class="bg-dark text-light p-3 mb-0" style="max-height: 200px; overflow-y: auto; font-size: 11px;">@selectedMotionEvent.Payload</pre>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(selectedMotionEvent.SnapshotPath))
                        {
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <strong>Snapshot Path</strong>
                                    </div>
                                    <div class="card-body">
                                        <code>@selectedMotionEvent.SnapshotPath</code>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseMotionDetailModal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
}

@* Config Detail Modal *@
@if (showConfigDetailModal && selectedConfigLog != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.7);" @onclick="CloseConfigDetailModal">
        <div class="modal-dialog modal-xl" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-text"></i> Chi tiết thay đổi cấu hình
                    </h5>
                    <button type="button" class="close" @onclick="CloseConfigDetailModal" @onclick:stopPropagation="true">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Basic Info -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <strong>Thông tin cơ bản</strong>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless mb-0">
                                        <tbody>
                                            <tr>
                                                <td class="text-muted" style="width: 150px;">Loại:</td>
                                                <td><span class="badge bg-info">@selectedConfigLog.EntityType</span></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Tên:</td>
                                                <td><strong>@selectedConfigLog.EntityName</strong></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Hành động:</td>
                                                <td>
                                                    @{
                                                        var badgeClass = selectedConfigLog.ActionType switch
                                                        {
                                                            "Create" => "bg-success",
                                                            "Update" => "bg-warning text-dark",
                                                            "Delete" => "bg-danger",
                                                            _ => "bg-secondary"
                                                        };
                                                    }
                                                    <span class="badge @badgeClass">@selectedConfigLog.ActionType</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- User Info -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <strong>Thông tin người thực hiện</strong>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless mb-0">
                                        <tbody>
                                            <tr>
                                                <td class="text-muted" style="width: 150px;">Người thực hiện:</td>
                                                <td><strong>@selectedConfigLog.ChangedBy</strong></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Thời gian:</td>
                                                <td><strong>@ConvertToLocalTime(selectedConfigLog.ChangedAt)</strong></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">IP Address:</td>
                                                <td><code>@(selectedConfigLog.IpAddress ?? "N/A")</code></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">User Agent:</td>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(selectedConfigLog.UserAgent))
                                                    {
                                                        <small class="text-muted">@selectedConfigLog.UserAgent</small>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">N/A</span>
                                                    }
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Changes Summary -->
                        @if (!string.IsNullOrEmpty(selectedConfigLog.Changes))
                        {
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <strong>Tóm tắt thay đổi</strong>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-info mb-0">
                                            <i class="bi bi-info-circle"></i> @selectedConfigLog.Changes
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- Old Value -->
                        @if (!string.IsNullOrEmpty(selectedConfigLog.OldValue) && selectedConfigLog.ActionType == "Update")
                        {
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <strong>Giá trị cũ</strong>
                                    </div>
                                    <div class="card-body">
                                        @{
                                            var oldValueFormatted = FormatJsonValue(selectedConfigLog.OldValue);
                                        }
                                        @if (oldValueFormatted != null)
                                        {
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th style="width: 40%;">Thuộc tính</th>
                                                        <th>Giá trị</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var kvp in oldValueFormatted)
                                                    {
                                                        <tr>
                                                            <td class="text-muted"><strong>@kvp.Key</strong></td>
                                                            <td><code>@kvp.Value</code></td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        }
                                        else
                                        {
                                            <pre class="bg-dark text-light p-3 mb-0" style="max-height: 400px; overflow-y: auto; font-size: 11px;">@selectedConfigLog.OldValue</pre>
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- New Value -->
                        @if (!string.IsNullOrEmpty(selectedConfigLog.NewValue))
                        {
                            <div class="col-md-@(selectedConfigLog.ActionType == "Update" ? "6" : "12")">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <strong>Giá trị mới</strong>
                                    </div>
                                    <div class="card-body">
                                        @{
                                            var newValueFormatted = FormatJsonValue(selectedConfigLog.NewValue);
                                        }
                                        @if (newValueFormatted != null)
                                        {
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th style="width: 40%;">Thuộc tính</th>
                                                        <th>Giá trị</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var kvp in newValueFormatted)
                                                    {
                                                        <tr>
                                                            <td class="text-muted"><strong>@kvp.Key</strong></td>
                                                            <td><code>@kvp.Value</code></td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        }
                                        else
                                        {
                                            <pre class="bg-dark text-light p-3 mb-0" style="max-height: 400px; overflow-y: auto; font-size: 11px;">@selectedConfigLog.NewValue</pre>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseConfigDetailModal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
}

@* Resolve Alert Modal with Reason Input *@
@if (showResolveModal && !string.IsNullOrEmpty(resolveAlertId))
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle"></i> Xác nhận xử lý cảnh báo
                    </h5>
                    <button type="button" class="close" @onclick="CloseResolveModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Lý do xử lý <span class="text-danger">*</span></label>
                        <textarea class="form-control" rows="3" @bind="resolveReason" 
                                  placeholder="Nhập lý do tại sao bạn đánh dấu cảnh báo này đã xử lý..."></textarea>
                        @if (string.IsNullOrWhiteSpace(resolveReason))
                        {
                            <small class="text-muted">Vui lòng nhập lý do xử lý</small>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseResolveModal">Hủy</button>
                    <button type="button" class="btn btn-success" 
                            @onclick="ConfirmResolveAlert" 
                            disabled="@string.IsNullOrWhiteSpace(resolveReason)">
                        <i class="bi bi-check-circle"></i> Xác nhận xử lý
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Station> stations = new();
    private Dictionary<Guid, MotionAlert> latestStationAlerts = new();
    private HashSet<Guid> stationsWithActiveMonitoring = new();
    private bool isLoading = false;
    private DateTime lastUpdateTime = DateTime.Now;
    private System.Threading.Timer? refreshTimer;
    private bool isFullscreen = false;
    private bool isStationEmployeeRole = false;

    // Modal state
    private bool showStationModal = false;
    private bool isLoadingStationDetails = false; // 🔥 Loading spinner for modal
    private Station? selectedStation = null;
    private string activeTab = "motion";
    private List<MotionEvent> motionHistory = new();
    private List<MotionAlert> alertHistory = new();
    private List<ConfigurationAuditLog> configHistory = new();
    private HashSet<string> expandedSnapshots = new();
    
    // Motion detail modal
    private bool showMotionDetailModal = false;
    private MotionEvent? selectedMotionEvent = null;

    // Config detail modal
    private bool showConfigDetailModal = false;
    private ConfigurationAuditLog? selectedConfigLog = null;

    // Resolve modal
    private bool showResolveModal = false;
    private string? resolveAlertId = null;
    private string resolveReason = string.Empty;

    // Pagination for motion history
    private int motionPageSize = 20;
    private int motionPageIndex = 0;
    private int motionTotalCount = 0;

    public enum StationStatus
    {
        Normal,   // 🟢 Có nhấn nút trong khoảng cho phép
        Alert,    // 🔴 Quá thời gian không có nhấn nút
        Paused    // ⚪ Tạm ngưng giám sát
    }

    protected override async Task OnInitializedAsync()
    {
        // Check user role
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isStationEmployeeRole = user.IsInRole("StationEmployee");
        
        await LoadStations();
        
        // Auto-refresh every 30 seconds
        refreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadStations();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private async Task LoadStations()
    {
        isLoading = true;
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            
            // Load all active stations
            stations = await context.Stations
                .OrderBy(s => s.Name)
                .ToListAsync();

            // Load latest alert for each station (to determine current status)
            // Include resolved alerts to calculate station status correctly
            var latestAlerts = await context.MotionAlerts
                .Where(a => a.StationId != null)
                .GroupBy(a => a.StationId!.Value)
                .Select(g => new
                {
                    StationId = g.Key,
                    LatestAlert = g.OrderByDescending(a => a.AlertTime).FirstOrDefault()
                })
                .ToListAsync();

            latestStationAlerts = latestAlerts
                .Where(x => x.LatestAlert != null)
                .ToDictionary(x => x.StationId, x => x.LatestAlert!);
            
            // Load stations with active monitoring (enabled TimeFrames)
            var activeStationIds = await context.TimeFrames
                .Where(tf => tf.IsEnabled && tf.StationId != null)
                .Select(tf => tf.StationId!.Value)
                .Distinct()
                .ToListAsync();
            
            stationsWithActiveMonitoring = new HashSet<Guid>(activeStationIds);
            
            lastUpdateTime = DateTime.UtcNow;
        }
        finally
        {
            isLoading = false;
        }
    }

    private StationStatus GetStationStatus(Station station)
    {
        // Check if station has active monitoring (has enabled timeframes)
        var hasActiveMonitoring = stationsWithActiveMonitoring.Contains(station.Id);

        if (!hasActiveMonitoring || !station.IsActive)
        {
            return StationStatus.Paused;
        }

        // Check latest alert status - if latest alert is resolved or no alerts, status is Normal
        // If latest alert is unresolved, status is Alert
        if (latestStationAlerts.ContainsKey(station.Id))
        {
            var latestAlert = latestStationAlerts[station.Id];
            if (!latestAlert.IsResolved)
            {
                return StationStatus.Alert;
            }
        }

        return StationStatus.Normal;
    }

    private string GetStatusClass(StationStatus status)
    {
        return status switch
        {
            StationStatus.Normal => "status-normal",
            StationStatus.Alert => "status-alert",
            StationStatus.Paused => "status-paused",
            _ => ""
        };
    }

    private string GetStatusIndicatorClass(StationStatus status)
    {
        return status switch
        {
            StationStatus.Normal => "status-normal",
            StationStatus.Alert => "status-alert",
            StationStatus.Paused => "status-paused",
            _ => ""
        };
    }

    private string GetStatusBadgeClass(StationStatus status)
    {
        return status switch
        {
            StationStatus.Normal => "bg-success",
            StationStatus.Alert => "bg-danger",
            StationStatus.Paused => "bg-secondary",
            _ => "bg-info"
        };
    }

    private string GetStatusText(StationStatus status)
    {
        return status switch
        {
            StationStatus.Normal => "Bình thường",
            StationStatus.Alert => "Cảnh báo",
            StationStatus.Paused => "Tạm ngưng",
            _ => "N/A"
        };
    }

    private async Task ShowStationDetails(Station station)
    {
        // Show modal immediately with loading spinner
        selectedStation = station;
        activeTab = isStationEmployeeRole ? "alerts" : "motion";
        expandedSnapshots.Clear();
        motionPageIndex = 0;
        motionHistory.Clear();
        alertHistory.Clear();
        configHistory.Clear();
        
        showStationModal = true;
        isLoadingStationDetails = true;
        StateHasChanged(); // Force render to show spinner

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            
            // 🔥 OPTIMIZATION: Load only the active tab data first
            if (activeTab == "alerts")
            {
                // Load alert history first (most important for employees)
                await LoadAlertHistoryAsync(context, station.Id);
            }
            else if (activeTab == "motion")
            {
                // Load motion history with pagination (top 100 records)
                await LoadMotionHistoryAsync(context, station.Id);
            }
            
            // Render immediately with first tab data
            StateHasChanged();
        }
        finally
        {
            isLoadingStationDetails = false;
            StateHasChanged();
        }
    }

    private async Task LoadAlertHistoryAsync(ApplicationDbContext context, Guid stationId)
    {
        var thirtyDaysAgo = DateTime.UtcNow.AddDays(-30);
        alertHistory = await context.MotionAlerts
            .Include(a => a.TimeFrame)
            .Include(a => a.TimeFrameHistorySnapshot)
            .Where(a => a.StationId == stationId && a.AlertTime >= thirtyDaysAgo && !a.IsDeleted)
            .OrderByDescending(a => a.AlertTime)
            .ToListAsync();
    }

    private async Task LoadMotionHistoryAsync(ApplicationDbContext context, Guid stationId)
    {
        // 🔥 OPTIMIZATION: Load only top 100 motion events instead of ALL
        motionHistory = await context.MotionEvents
            .Where(m => m.StationId == stationId)
            .OrderByDescending(m => m.DetectedAt)
            .Take(100) // Only load latest 100 records
            .ToListAsync();
    }

    private async Task LoadConfigHistoryAsync(ApplicationDbContext context, Guid stationId)
    {
        var ninetyDaysAgo = DateTime.UtcNow.AddDays(-90);
        
        // Get all TimeFrame IDs for this station
        var timeFrameIds = await context.TimeFrames
            .Where(tf => tf.StationId == stationId)
            .Select(tf => tf.Id)
            .ToListAsync();
        
        configHistory = await context.ConfigurationAuditLogs
            .Where(a => a.ChangedAt >= ninetyDaysAgo && 
                       ((a.EntityType == "Station" && a.EntityId == stationId) ||
                        (a.EntityType == "TimeFrame" && timeFrameIds.Contains(a.EntityId))))
            .OrderByDescending(a => a.ChangedAt)
            .ToListAsync();
    }

    private void CloseStationModal()
    {
        showStationModal = false;
        selectedStation = null;
        motionHistory.Clear();
        alertHistory.Clear();
        configHistory.Clear();
        expandedSnapshots.Clear();
        motionPageIndex = 0;
        motionTotalCount = 0;
    }

    private void ShowMotionDetail(MotionEvent motion)
    {
        selectedMotionEvent = motion;
        showMotionDetailModal = true;
    }

    private void CloseMotionDetailModal()
    {
        showMotionDetailModal = false;
        selectedMotionEvent = null;
    }

    private void ShowConfigDetailModal(ConfigurationAuditLog log)
    {
        selectedConfigLog = log;
        showConfigDetailModal = true;
    }

    private void CloseConfigDetailModal()
    {
        showConfigDetailModal = false;
        selectedConfigLog = null;
    }

    private Dictionary<string, string>? ParsePayload(string? payload)
    {
        if (string.IsNullOrWhiteSpace(payload))
            return null;

        try
        {
            var data = new Dictionary<string, string>();
            
            // Try to parse JSON-like payload
            var lines = payload.Split(new[] { '\n', '\r', ',' }, StringSplitOptions.RemoveEmptyEntries);
            foreach (var line in lines)
            {
                var trimmed = line.Trim().Trim('{', '}');
                if (trimmed.Contains(':'))
                {
                    var parts = trimmed.Split(':', 2);
                    if (parts.Length == 2)
                    {
                        var key = parts[0].Trim().Trim('"');
                        var value = parts[1].Trim().Trim('"', ' ');
                        data[key] = value;
                    }
                }
            }
            
            return data.Any() ? data : null;
        }
        catch
        {
            return null;
        }
    }

    private void ShowResolveModal(string alertId)
    {
        resolveAlertId = alertId;
        resolveReason = string.Empty;
        showResolveModal = true;
    }

    private void CloseResolveModal()
    {
        showResolveModal = false;
        resolveAlertId = null;
        resolveReason = string.Empty;
    }

    private async Task ConfirmResolveAlert()
    {
        if (string.IsNullOrWhiteSpace(resolveReason) || string.IsNullOrWhiteSpace(resolveAlertId))
            return;

        await ResolveAlert(resolveAlertId, resolveReason);
        CloseResolveModal();
    }

    private async Task ResolveAlert(string alertId, string reason)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            
            var alert = await context.MotionAlerts.FindAsync(alertId);
            if (alert != null && !alert.IsResolved)
            {
                alert.IsResolved = true;
                alert.ResolvedAt = DateTime.UtcNow;
                alert.ResolvedBy = "Manual Resolve"; // TODO: Get current user name
                alert.IsDeleted = true; // Hide resolved alert from display
                alert.Notes = reason; // ✅ Save the reason
                
                await context.SaveChangesAsync();
                
                // Reload only alert history without changing tabs
                var thirtyDaysAgo = DateTime.Now.AddDays(-30);
                alertHistory = await context.MotionAlerts
                    .Include(a => a.TimeFrame)
                    .Include(a => a.TimeFrameHistorySnapshot)
                    .Where(a => a.StationId == selectedStation!.Id && a.AlertTime >= thirtyDaysAgo && !a.IsDeleted)
                    .OrderByDescending(a => a.AlertTime)
                    .ToListAsync();
                
                await JSRuntime.InvokeVoidAsync("showToast", "Đã đánh dấu cảnh báo đã xử lý thành công!", "success");
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error resolving alert: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("showToast", $"Lỗi khi xử lý cảnh báo: {ex.Message}", "error");
        }
    }

    private Dictionary<string, string>? ParseConfigSnapshot(string? jsonConfig)
    {
        if (string.IsNullOrWhiteSpace(jsonConfig))
            return null;

        try
        {
            // Use JsonDocument for proper JSON parsing with Unicode support
            using var doc = JsonDocument.Parse(jsonConfig);
            var root = doc.RootElement;
            
            var config = new Dictionary<string, string>();
            
            foreach (var property in root.EnumerateObject())
            {
                var key = property.Name;
                var value = property.Value;
                
                // Convert to string based on type
                string displayValue = value.ValueKind switch
                {
                    JsonValueKind.String => value.GetString() ?? "",
                    JsonValueKind.Number => value.ToString(),
                    JsonValueKind.True => "true",
                    JsonValueKind.False => "false",
                    JsonValueKind.Null => "N/A",
                    _ => value.ToString()
                };
                
                config[key] = displayValue;
            }
            
            return config.Any() ? config : null;
        }
        catch
        {
            return null;
        }
    }

    private void ToggleConfigSnapshot(string alertId)
    {
        if (expandedSnapshots.Contains(alertId))
        {
            expandedSnapshots.Remove(alertId);
        }
        else
        {
            expandedSnapshots.Add(alertId);
        }
    }

    private Dictionary<string, string>? FormatJsonValue(string? jsonValue)
    {
        if (string.IsNullOrWhiteSpace(jsonValue))
            return null;

        try
        {
            // Try to parse as proper JSON first
            using var doc = JsonDocument.Parse(jsonValue);
            var root = doc.RootElement;
            
            var data = new Dictionary<string, string>();
            
            // Properties to exclude from display
            var excludedProperties = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
            {
                "Station", "TimeFrames", "StationEmployees", "Profile", "TimeFrame", "MotionAlerts",
                "Id", "StationId", "ProfileId", "TimeFrameId", "EntityId", // Hide all ID columns
                "CreatedBy", "ModifiedBy", "DeletedBy" // Hide technical fields
            };
            
            foreach (var property in root.EnumerateObject())
            {
                var key = property.Name;
                
                // Skip excluded properties and properties ending with "Id"
                if (excludedProperties.Contains(key) || key.EndsWith("Id", StringComparison.OrdinalIgnoreCase))
                    continue;
                
                var value = property.Value;
                string displayValue;
                
                // Format based on property type
                if (key == "IsActive" || key == "IsEnabled")
                {
                    displayValue = value.GetBoolean() ? "✓ Có" : "✗ Không";
                }
                else if (key == "DaysOfWeek" && value.ValueKind == JsonValueKind.Array)
                {
                    var days = new List<string>();
                    foreach (var day in value.EnumerateArray())
                    {
                        var dayNum = day.GetInt32().ToString();
                        days.Add(dayNum switch
                        {
                            "0" => "CN",
                            "1" => "T2",
                            "2" => "T3",
                            "3" => "T4",
                            "4" => "T5",
                            "5" => "T6",
                            "6" => "T7",
                            _ => dayNum
                        });
                    }
                    displayValue = string.Join(", ", days);
                }
                else if ((key == "StartTime" || key == "EndTime") && value.ValueKind == JsonValueKind.String)
                {
                    // Handle StartTime and EndTime as TimeSpan (show only HH:mm:ss)
                    var timeStr = value.GetString() ?? "";
                    if (TimeSpan.TryParse(timeStr, out var timeSpan))
                    {
                        displayValue = timeSpan.ToString(@"hh\:mm\:ss");
                    }
                    else if (DateTime.TryParse(timeStr, out var dateValue))
                    {
                        displayValue = dateValue.TimeOfDay.ToString(@"hh\:mm\:ss");
                    }
                    else
                    {
                        displayValue = timeStr;
                    }
                }
                else if ((key.Contains("Time") || key.Contains("Date")) && value.ValueKind == JsonValueKind.String)
                {
                    if (DateTime.TryParse(value.GetString(), out var dateValue))
                    {
                        // Ensure datetime is treated as UTC before converting to local time
                        if (dateValue.Kind == DateTimeKind.Unspecified)
                        {
                            dateValue = DateTime.SpecifyKind(dateValue, DateTimeKind.Utc);
                        }
                        displayValue = ConvertToLocalTime(dateValue);
                    }
                    else
                    {
                        displayValue = value.GetString() ?? "";
                    }
                }
                else if (value.ValueKind == JsonValueKind.String)
                {
                    displayValue = value.GetString() ?? "";
                }
                else if (value.ValueKind == JsonValueKind.Number)
                {
                    displayValue = value.ToString();
                }
                else if (value.ValueKind == JsonValueKind.True || value.ValueKind == JsonValueKind.False)
                {
                    displayValue = value.GetBoolean() ? "✓ Có" : "✗ Không";
                }
                else if (value.ValueKind == JsonValueKind.Null)
                {
                    displayValue = "N/A";
                }
                else
                {
                    displayValue = value.ToString();
                }
                
                data[key] = displayValue;
            }
            
            return data.Any() ? data : null;
        }
        catch
        {
            return null;
        }
    }

    private string ConvertToLocalTime(DateTime utcTime)
    {
        // Convert UTC to local time for display
        var localTime = utcTime.ToLocalTime();
        return localTime.ToString("dd/MM/yyyy HH:mm:ss");
    }

    private string GetStationNameById(Guid stationId)
    {
        // Try to find station in cached list first
        var station = stations.FirstOrDefault(s => s.Id == stationId);
        if (station != null)
        {
            return $"{station.Name} (ID: {stationId})";
        }
        
        // Fallback: just show ID
        return $"Trạm #{stationId}";
    }

    private string FormatDateTimeFromConfig(string dateTimeStr)
    {
        if (string.IsNullOrWhiteSpace(dateTimeStr) || dateTimeStr == "N/A")
            return "N/A";
            
        try
        {
            if (DateTime.TryParse(dateTimeStr, out var utcTime))
            {
                return ConvertToLocalTime(utcTime);
            }
            return dateTimeStr;
        }
        catch
        {
            return dateTimeStr;
        }
    }

    private string FormatTimeSpan(string timeStr)
    {
        if (string.IsNullOrWhiteSpace(timeStr) || timeStr == "N/A")
            return "N/A";
            
        try
        {
            if (TimeSpan.TryParse(timeStr, out var timeSpan))
            {
                return timeSpan.ToString(@"hh\:mm\:ss");
            }
            else if (DateTime.TryParse(timeStr, out var dateValue))
            {
                return dateValue.TimeOfDay.ToString(@"hh\:mm\:ss");
            }
            return timeStr;
        }
        catch
        {
            return timeStr;
        }
    }

    private async Task ToggleFullscreen()
    {
        isFullscreen = !isFullscreen;
        await JSRuntime.InvokeVoidAsync("toggleFullscreen", isFullscreen);
    }

    // 🔥 Tab switching methods with lazy loading
    private async Task SwitchToMotionTab()
    {
        if (activeTab == "motion") return;
        
        activeTab = "motion";
        
        if (motionHistory.Count == 0 && selectedStation != null)
        {
            isLoadingStationDetails = true;
            StateHasChanged();
            
            try
            {
                using var context = await DbContextFactory.CreateDbContextAsync();
                await LoadMotionHistoryAsync(context, selectedStation.Id);
            }
            finally
            {
                isLoadingStationDetails = false;
                StateHasChanged();
            }
        }
    }

    private async Task SwitchToAlertsTab()
    {
        if (activeTab == "alerts") return;
        
        activeTab = "alerts";
        
        if (alertHistory.Count == 0 && selectedStation != null)
        {
            isLoadingStationDetails = true;
            StateHasChanged();
            
            try
            {
                using var context = await DbContextFactory.CreateDbContextAsync();
                await LoadAlertHistoryAsync(context, selectedStation.Id);
            }
            finally
            {
                isLoadingStationDetails = false;
                StateHasChanged();
            }
        }
    }

    private async Task SwitchToConfigTab()
    {
        if (activeTab == "config-history") return;
        
        activeTab = "config-history";
        
        if (configHistory.Count == 0 && selectedStation != null)
        {
            isLoadingStationDetails = true;
            StateHasChanged();
            
            try
            {
                using var context = await DbContextFactory.CreateDbContextAsync();
                await LoadConfigHistoryAsync(context, selectedStation.Id);
            }
            finally
            {
                isLoadingStationDetails = false;
                StateHasChanged();
            }
        }
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }
}

<style>
    .station-status-panel {
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        position: relative;
    }

    /* Fullscreen mode */
    .station-status-panel.fullscreen-mode {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 9999;
        border: none;
        border-radius: 0;
        padding: 30px;
        overflow-y: auto;
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #dee2e6;
    }

    .panel-header h4 {
        margin: 0;
        color: #333;
    }

    .stations-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 10px;
        margin-bottom: 20px;
    }

    /* Responsive: điều chỉnh số cột dựa trên kích thước màn hình */
    @@media (max-width: 1920px) {
        .stations-grid {
            grid-template-columns: repeat(6, 1fr);
        }
    }

    @@media (max-width: 1600px) {
        .stations-grid {
            grid-template-columns: repeat(5, 1fr);
        }
    }

    @@media (max-width: 1200px) {
        .stations-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    @@media (max-width: 992px) {
        .stations-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @@media (max-width: 768px) {
        .stations-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 576px) {
        .stations-grid {
            grid-template-columns: 1fr;
        }
    }

    .station-card {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 16px 12px;
        background: white;
        transition: all 0.2s ease;
        min-height: 75px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        cursor: pointer;
    }

    .station-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transform: translateY(-1px);
    }

    .station-card.status-normal {
        border-left: 4px solid #10b981;
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    }

    .station-card.status-alert {
        border-left: 4px solid #ef4444;
        background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
    }

    .station-card.status-paused {
        border-left: 4px solid #9ca3af;
        background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
    }

    /* Station header (for modal only) */
    .station-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
    }

    /* Layout compact cho station card */
    .station-compact {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-align: center;
        width: 100%;
    }

    /* Tên trạm compact */
    .station-name-compact {
        font-size: 18px;
        font-weight: 600;
        color: #2c3e50;
        line-height: 1.4;
        word-break: break-word;
        text-align: center;
    }

    /* Tên trạm nổi bật (legacy - keep for modal) */
    .station-name-large {
        font-size: 22px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #1a1a1a;
        line-height: 1.3;
        margin: 0;
    }

    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
        box-shadow: 0 0 0 0 rgba(0,0,0,0.1);
        position: relative;
    }

    .status-indicator.status-normal {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        animation: pulse-green 2s infinite;
    }

    .status-indicator.status-alert {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        animation: pulse-red 2s infinite;
    }

    .status-indicator.status-paused {
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
        opacity: 0.7;
    }

    @@keyframes pulse-green {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
        }
        50% {
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0);
        }
    }

    @@keyframes pulse-red {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
        }
        50% {
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0);
        }
    }

    /* Modal-only styles */
    .station-body {
        margin: 12px 0;
        flex-grow: 1;
    }

    .status-detail {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .station-address {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px dashed #dee2e6;
        display: flex;
        align-items: center;
        gap: 6px;
        color: #666;
    }

    .station-footer {
        padding-top: 10px;
        border-top: 1px solid #dee2e6;
        text-align: right;
    }

    .panel-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 15px;
        border-top: 2px solid #dee2e6;
    }

    .legend {
        display: flex;
        gap: 20px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
    }

    /* Modal styles */
    .modal.show {
        z-index: 10000 !important; /* Higher than fullscreen panel (9999) */
    }

    .modal-dialog {
        z-index: 10001 !important;
    }

    .modal-backdrop {
        z-index: 9999 !important;
    }

    .motion-history, .alerts-history {
        max-height: 600px;
        overflow-y: auto;
    }

    .alert-history-card {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        background: white;
    }

    .alert-history-card.resolved {
        opacity: 0.8;
        background: #f8f9fa;
    }

    .alert-history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .alert-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .alert-details-grid div {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .resolved-info {
        padding: 8px;
        background: #d1e7dd;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .config-snapshot {
        padding: 10px;
        background: #e7f3ff;
        border-radius: 4px;
    }

    .config-json {
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
    }

    .nav-tabs .nav-link {
        cursor: pointer;
    }

    .alerts-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* Modal close button fixes */
    .modal-header .close {
        padding: 0;
        background-color: transparent;
        border: 0;
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1;
        color: #000;
        text-shadow: 0 1px 0 #fff;
        opacity: 0.5;
    }

    .modal-header .close:hover {
        opacity: 0.75;
    }

    .modal-header .close:focus {
        outline: 0;
    }
    
    .modal-header .close.text-white {
        color: #fff;
        text-shadow: 0 1px 0 rgba(0,0,0,0.5);
    }

    /* Bootstrap gap utility fallback */
    .gap-1 > *:not(:last-child) {
        margin-right: 0.25rem;
    }

    .gap-2 > *:not(:last-child) {
        margin-right: 0.5rem;
    }
</style>
