@using StationCheck.Models
@using StationCheck.Interfaces
@using DevExpress.Blazor
@using Microsoft.AspNetCore.Components.Forms
@inject IMonitoringService MonitoringService
@inject IStationService StationService
@inject IJSRuntime JS

<DxPopup @bind-Visible="@Visible"
         HeaderText="@($"‚è∞ {Title}")"
         ShowCloseButton="true"
         Width="900px"
         MaxWidth="95%"
         Height="auto"
         MaxHeight="90vh"
         CloseOnOutsideClick="false"
         CssClass="timeframe-config-modal">
    <BodyContentTemplate Context="popupContext">
        <div class="p-3">
            @if (isLoading)
            {
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
            else
            {
                <!-- Toolbar with actions -->
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <div>
                        <button class="btn btn-success btn-sm me-2" @onclick="ShowAddForm">
                            <i class="fas fa-plus"></i> Th√™m khung th·ªùi gian
                        </button>
                        @if (timeFrames.Any())
                        {
                            <button class="btn btn-primary btn-sm me-2" @onclick="() => BulkToggle(true)">
                                <i class="fas fa-check-circle"></i> B·∫≠t t·∫•t c·∫£
                            </button>
                            <button class="btn btn-secondary btn-sm me-2" @onclick="() => BulkToggle(false)">
                                <i class="fas fa-times-circle"></i> T·∫Øt t·∫•t c·∫£
                            </button>
                        }
                        <button class="btn btn-info btn-sm" @onclick="ShowCopyDialog">
                            <i class="fas fa-copy"></i> Copy t·ª´ tr·∫°m kh√°c
                        </button>
                    </div>
                    <span class="badge bg-info">@timeFrames.Count khung th·ªùi gian</span>
                </div>

                <!-- TimeFrames List -->
                @if (!timeFrames.Any())
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i>
                        Ch∆∞a c√≥ khung th·ªùi gian n√†o. Nh·∫•n "Th√™m khung th·ªùi gian" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 20%;">T√™n khung</th>
                                    <th style="width: 18%;">Th·ªùi gian</th>
                                    <th style="width: 12%;">T·∫ßn su·∫•t</th>
                                    <th style="width: 10%;">Buffer</th>
                                    <th style="width: 25%;">Ng√†y trong tu·∫ßn</th>
                                    <th style="width: 10%;">Tr·∫°ng th√°i</th>
                                    <th style="width: 5%;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var tf in timeFrames)
                                {
                                    <tr>
                                        <td>
                                            <strong>@tf.Name</strong>
                                        </td>
                                        <td>
                                            <i class="fas fa-clock text-primary"></i>
                                            @tf.StartTime.ToString(@"hh\:mm") - @tf.EndTime.ToString(@"hh\:mm")
                                        </td>
                                        <td>
                                            <span class="badge bg-info">@tf.FrequencyMinutes ph√∫t</span>
                                        </td>
                                        <td>
                                            @if (tf.BufferMinutes > 0)
                                            {
                                                <span class="badge bg-warning text-dark">+@tf.BufferMinutes ph√∫t</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            <small class="text-muted">@GetDaysOfWeekText(tf.DaysOfWeek ?? "127")</small>
                                        </td>
                                        <td>
                                            @if (tf.IsEnabled)
                                            {
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check"></i> B·∫≠t
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-times"></i> T·∫Øt
                                                </span>
                                            }
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" title="S·ª≠a" @onclick="() => ShowEditForm(tf)">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" title="X√≥a" @onclick="() => DeleteTimeFrame(tf)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            }
        </div>
    </BodyContentTemplate>
</DxPopup>

<!-- TimeFrame Add/Edit Form -->
@if (Visible && showFormModal)
{
    <TimeFrameForm @bind-Visible="showFormModal" 
                   StationId="@StationId" 
                   TimeFrame="@currentTimeFrame" 
                   OnSaved="HandleFormSaved" />
}

<!-- Copy Dialog -->
@if (Visible && showCopyModal)
{
    <DxPopup @bind-Visible="showCopyModal"
             HeaderText="üìã Copy khung th·ªùi gian"
             ShowCloseButton="true"
             Width="600px"
             MaxWidth="95%"
             Height="auto"
             MaxHeight="85vh">
        <BodyContentTemplate>
        <!-- Scrollable Content -->
        <div class="p-3" style="max-height: calc(85vh - 120px); overflow-y: auto;">
            <div class="mb-3">
                <label class="form-label">Ch·ªçn tr·∫°m ngu·ªìn:</label>
                <select value="@sourceStationId" @onchange="OnSourceStationChanged" class="form-select">
                    <option value="0">-- Ch·ªçn tr·∫°m --</option>
                    @foreach (var station in availableStations)
                    {
                        <option value="@station.Id">@station.Name</option>
                    }
                </select>
            </div>
            
            @if (sourceTimeFrames.Any())
            {
                <div class="mb-3">
                    <label class="form-label">Ch·ªçn khung th·ªùi gian c·∫ßn copy:</label>
                    
                    <!-- Select All Checkbox -->
                    <div class="form-check mb-2 bg-light p-2 rounded">
                        <input type="checkbox" class="form-check-input" id="selectAll" 
                               checked="@IsAllSelected()"
                               @onchange="ToggleSelectAll" />
                        <label class="form-check-label fw-bold" for="selectAll">
                            Ch·ªçn t·∫•t c·∫£ (@sourceTimeFrames.Count khung th·ªùi gian)
                        </label>
                    </div>
                    
                    <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                        @foreach (var tf in sourceTimeFrames)
                        {
                            <div class="form-check mb-2">
                                <input type="checkbox" class="form-check-input" id="tf_@tf.Id" 
                                       checked="@selectedTimeFrameIds.Contains(tf.Id)"
                                       @onchange="e => ToggleTimeFrameSelection(tf.Id, (bool)e.Value!)" />
                                <label class="form-check-label" for="tf_@tf.Id">
                                    <strong>@tf.Name</strong> - 
                                    @tf.StartTime.ToString(@"hh\:mm") ‚Üí @tf.EndTime.ToString(@"hh\:mm") 
                                    (@tf.FrequencyMinutes ph√∫t) - 
                                    <small class="text-muted">@GetDaysOfWeekText(tf.DaysOfWeek ?? "127")</small>
                                </label>
                            </div>
                        }
                    </div>
                    <small class="form-text text-muted">
                        ƒê√£ ch·ªçn: @selectedTimeFrameIds.Count / @sourceTimeFrames.Count khung th·ªùi gian
                    </small>
                </div>
            }
            else if (sourceStationId > 0)
            {
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Tr·∫°m n√†y ch∆∞a c√≥ khung th·ªùi gian n√†o.
                </div>
            }
        </div>
        
        <!-- Fixed Footer Buttons -->
        <div class="border-top p-3 bg-light d-flex justify-content-end gap-2">
            <button class="btn btn-secondary" @onclick="CloseCopyDialog">H·ªßy</button>
            <button class="btn btn-primary" @onclick="HandleCopy" disabled="@(!selectedTimeFrameIds.Any())">
                <i class="fas fa-copy"></i> Copy (@selectedTimeFrameIds.Count)
            </button>
        </div>
    </BodyContentTemplate>
</DxPopup>
}

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }
    [Parameter] public int StationId { get; set; }
    [Parameter] public string Title { get; set; } = "C·∫•u h√¨nh khung th·ªùi gian";

    private bool isLoading = true;
    private List<TimeFrame> timeFrames = new();
    
    private bool showFormModal = false;
    private bool showCopyModal = false;
    private TimeFrame currentTimeFrame = new();
    private int sourceStationId = 0;
    private List<Station> availableStations = new();
    private List<TimeFrame> sourceTimeFrames = new();
    private HashSet<int> selectedTimeFrameIds = new();

    protected override async Task OnParametersSetAsync()
    {
        if (Visible && StationId > 0)
        {
            isLoading = true;
            await LoadTimeFrames();
            await LoadAvailableStations();
            isLoading = false;
        }
        else if (!Visible)
        {
            // Reset ALL state when modal closes
            showFormModal = false;
            showCopyModal = false;
            currentTimeFrame = new();
            sourceStationId = 0;
            sourceTimeFrames = new();
            selectedTimeFrameIds = new();
            timeFrames = new();
            isLoading = false;
        }
    }

    private async Task LoadAvailableStations()
    {
        var allStations = await StationService.GetAllStationsAsync();
        availableStations = allStations.Where(s => s.Id != StationId).ToList();
    }

    private async Task HandleFormSaved()
    {
        showFormModal = false;
        await LoadTimeFrames();
    }

    private async Task LoadTimeFrames()
    {
        isLoading = true;
        try
        {
            timeFrames = await MonitoringService.GetTimeFramesByStationIdAsync(StationId);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task BulkToggle(bool enabled)
    {
        // Close other modals first
        showFormModal = false;
        showCopyModal = false;
        
        if (!await JS.InvokeAsync<bool>("confirm", $"B·∫°n c√≥ ch·∫Øc mu·ªën {(enabled ? "b·∫≠t" : "t·∫Øt")} t·∫•t c·∫£ {timeFrames.Count} khung th·ªùi gian?"))
        {
            return;
        }

        try
        {
            await MonitoringService.BulkToggleTimeFramesAsync(StationId, enabled);
            await LoadTimeFrames();
            await JS.InvokeVoidAsync("alert", $"ƒê√£ {(enabled ? "b·∫≠t" : "t·∫Øt")} th√†nh c√¥ng!");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"L·ªói: {ex.Message}");
        }
    }

    private void ShowAddForm()
    {
        // Close other modals first
        showCopyModal = false;
        
        currentTimeFrame = new TimeFrame { StationId = StationId };
        showFormModal = true;
    }

    private void ShowEditForm(TimeFrame tf)
    {
        // Close other modals first
        showCopyModal = false;
        
        currentTimeFrame = new TimeFrame
        {
            Id = tf.Id,
            Name = tf.Name,
            StartTime = tf.StartTime,
            EndTime = tf.EndTime,
            FrequencyMinutes = tf.FrequencyMinutes,
            BufferMinutes = tf.BufferMinutes,
            DaysOfWeek = tf.DaysOfWeek,
            IsEnabled = tf.IsEnabled,
            StationId = tf.StationId
        };
        showFormModal = true;
    }

    private async Task DeleteTimeFrame(TimeFrame tf)
    {
        if (!await JS.InvokeAsync<bool>("confirm", $"B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a khung '{tf.Name}'?"))
        {
            return;
        }

        try
        {
            await MonitoringService.DeleteTimeFrameAsync(tf.Id);
            await LoadTimeFrames();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"L·ªói: {ex.Message}");
        }
    }

    private void ShowCopyDialog()
    {
        // Close other modals first
        showFormModal = false;
        
        sourceStationId = 0;
        sourceTimeFrames = new();
        selectedTimeFrameIds = new();
        showCopyModal = true;
    }

    private async Task OnSourceStationChanged(ChangeEventArgs e)
    {
        sourceStationId = int.Parse(e.Value?.ToString() ?? "0");
        selectedTimeFrameIds.Clear();
        
        if (sourceStationId > 0)
        {
            await LoadSourceTimeFrames();
        }
        else
        {
            sourceTimeFrames = new();
        }
    }

    private async Task LoadSourceTimeFrames()
    {
        if (sourceStationId > 0)
        {
            sourceTimeFrames = await MonitoringService.GetTimeFramesByStationIdAsync(sourceStationId);
        }
    }

    private void ToggleTimeFrameSelection(int timeFrameId, bool isChecked)
    {
        if (isChecked)
        {
            selectedTimeFrameIds.Add(timeFrameId);
        }
        else
        {
            selectedTimeFrameIds.Remove(timeFrameId);
        }
    }

    private bool IsAllSelected()
    {
        return sourceTimeFrames.Any() && selectedTimeFrameIds.Count == sourceTimeFrames.Count;
    }

    private void ToggleSelectAll(ChangeEventArgs e)
    {
        var isChecked = (bool)e.Value!;
        
        if (isChecked)
        {
            // Ch·ªçn t·∫•t c·∫£
            selectedTimeFrameIds.Clear();
            foreach (var tf in sourceTimeFrames)
            {
                selectedTimeFrameIds.Add(tf.Id);
            }
        }
        else
        {
            // B·ªè ch·ªçn t·∫•t c·∫£
            selectedTimeFrameIds.Clear();
        }
    }

    private void CloseCopyDialog()
    {
        showCopyModal = false;
        sourceStationId = 0;
        sourceTimeFrames = new();
        selectedTimeFrameIds.Clear();
    }

    private async Task HandleCopy()
    {
        if (!selectedTimeFrameIds.Any())
        {
            await JS.InvokeVoidAsync("alert", "Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 khung th·ªùi gian!");
            return;
        }

        if (!await JS.InvokeAsync<bool>("confirm", $"Copy {selectedTimeFrameIds.Count} khung th·ªùi gian ƒë√£ ch·ªçn sang '{Title}'?"))
        {
            return;
        }

        try
        {
            // Copy t·ª´ng timeframe ƒë∆∞·ª£c ch·ªçn
            var selectedTimeFrames = sourceTimeFrames.Where(tf => selectedTimeFrameIds.Contains(tf.Id)).ToList();
            
            foreach (var tf in selectedTimeFrames)
            {
                var newTimeFrame = new TimeFrame
                {
                    Name = tf.Name,
                    StartTime = tf.StartTime,
                    EndTime = tf.EndTime,
                    FrequencyMinutes = tf.FrequencyMinutes,
                    DaysOfWeek = tf.DaysOfWeek,
                    IsEnabled = tf.IsEnabled
                };
                
                await MonitoringService.CreateTimeFrameForStationAsync(StationId, newTimeFrame);
            }
            
            await LoadTimeFrames();
            CloseCopyDialog();
            await JS.InvokeVoidAsync("alert", $"ƒê√£ copy th√†nh c√¥ng {selectedTimeFrames.Count} khung th·ªùi gian!");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"L·ªói: {ex.Message}");
        }
    }

    private string GetDaysOfWeekText(string daysOfWeek)
    {
        if (string.IsNullOrEmpty(daysOfWeek))
        {
            return "M·ªói ng√†y";
        }

        // Parse bitmask or comma-separated format
        List<int> days;
        if (daysOfWeek.Contains(","))
        {
            days = daysOfWeek.Split(',').Select(int.Parse).ToList();
        }
        else
        {
            int bitmask = int.Parse(daysOfWeek);
            days = new List<int>();
            for (int i = 1; i <= 7; i++)
            {
                if ((bitmask & (1 << (i - 1))) != 0)
                {
                    days.Add(i);
                }
            }
        }

        if (days.Count == 7)
        {
            return "M·ªói ng√†y";
        }

        var dayNames = new[] { "T2", "T3", "T4", "T5", "T6", "T7", "CN" };
        return string.Join(", ", days.Select(d => dayNames[d - 1]));
    }
}
