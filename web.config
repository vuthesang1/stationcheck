<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <location path="." inheritInChildApplications="false">
    <system.webServer>
      
      <!-- Redirect HTTP to HTTPS -->
      <rewrite>
        <rules>
          <rule name="HTTPS Redirect" stopProcessing="true">
            <match url="(.*)" />
            <conditions>
              <add input="{HTTPS}" pattern="^OFF$" />
            </conditions>
            <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
          </rule>
        </rules>
      </rewrite>
      
      <!-- Security: Require HTTPS -->
      <security>
        <access sslFlags="Ssl" />
      </security>
      
      <!-- ASP.NET Core Module Configuration -->
      <handlers>
        <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
      </handlers>
      
      <!-- ASP.NET Core Application Settings -->
      <aspNetCore processPath="dotnet" 
                  arguments=".\StationCheck.dll" 
                  stdoutLogEnabled="true" 
                  stdoutLogFile=".\logs\stdout"
                  hostingModel="inprocess">
      </aspNetCore>
      
    </system.webServer>
  </location>
  
  <!-- 
    Allow anonymous access to DesktopApp download
    Users need to download desktop login app
  -->
  <location path="wwwroot/DesktopApp">
    <system.webServer>
      <!-- This location allows download without authentication -->
    </system.webServer>
  </location>
  
  <!--
    ============================================================
    MAC Address Authentication
    ============================================================
    
    This application uses MAC address-based authentication via desktop app.
    
    Authentication Flow:
    1. User downloads desktop login app from /wwwroot/DesktopApp
    2. Desktop app sends POST /api/device-login with username, password, and MAC address
    3. Server validates credentials and MAC address
    4. If device is approved: Desktop app receives JWT token
    5. Desktop app opens browser with /tokenlogin?token={jwt}
    6. Web application creates session from JWT token
    
    Device Management:
    - New devices are registered with PendingApproval status
    - Admin approves devices in Device Management page
    - Revoked devices trigger automatic logout via AccessControlMiddleware
    
    Force Logout:
    - When device is revoked or user is removed from device
    - AccessControlMiddleware returns 401 on every request
    - Blazor Server disconnects and forces logout
    
    No client certificates required!
    ============================================================
  -->
  
</configuration>
    ============================================================
    
    The <security><access> and <modules> sections are LOCKED by Plesk.
    You MUST configure IIS SSL settings using one of these methods:
    
    
    Method 1: PowerShell Script (RECOMMENDED)
    ==========================================
    
    Run as Administrator on the Plesk server:
    
    .\Configure-IIS-ClientCert.ps1 -SiteName "pvgascng.vn"
    
    This script will:
    1. Check if WebAdministration module is available
    2. Set sslFlags to "Ssl,SslNegotiateCert"
    3. Restart application pool
    4. Verify configuration
    
    
    Method 2: Manual PowerShell Commands
    ====================================
    
    Import-Module WebAdministration
    
    # Configure SSL to request (but not require) client certificates
    Set-WebConfigurationProperty `
        -PSPath "IIS:\Sites\pvgascng.vn" `
        -Filter "system.webServer/security/access" `
        -Name "sslFlags" `
        -Value "Ssl,SslNegotiateCert"
    
    # Restart application pool
    Restart-WebAppPool -Name "pvgascng.vn"
    
    
    Method 3: Unlock Sections (Requires Admin)
    ==========================================
    
    Only if Methods 1 and 2 fail, unlock the sections:
    
    1. Edit: C:\Windows\System32\inetsrv\config\applicationHost.config
    
    2. Find and change:
       <section name="access" overrideModeDefault="Deny" />
       TO:
       <section name="access" overrideModeDefault="Allow" />
    
    3. Restart IIS:
       iisreset
    
    4. Then you can add <security><access> to this web.config
    
    
    ============================================================
    Why These Settings?
    ============================================================
    
    Ssl: Require HTTPS
    SslNegotiateCert: Request client certificate but don't validate chain
    
    This allows self-signed DeviceInstaller certificates to:
    1. Be sent by browser to IIS
    2. Pass through IIS without validation
    3. Be forwarded to ASP.NET Core via X-ARR-ClientCert header
    4. Be validated by custom logic in Program.cs
    
    
    ============================================================
    Troubleshooting
    ============================================================
    
    Error: Section is locked
    Solution: Use Method 1 (PowerShell script) or Method 2 (manual PowerShell)
    
    Error: Certificate not forwarded to app
    Solution: Verify ASPNETCORE_FORWARDCLIENTCERTIFICATE is set above
    
    Error: 403.16 Forbidden
    Solution: Use "SslNegotiateCert" not "SslRequireCert"
    
    Error: Browser doesn't send certificate
    Solution: Verify IIS sslFlags includes "SslNegotiateCert"
  -->
  
</configuration>
