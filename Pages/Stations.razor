@page "/stations"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using StationCheck.Models
@using StationCheck.Interfaces
@using StationCheck.Services
@using DevExpress.Data.Linq
@inherits OwningComponentBase
@implements IDisposable
@attribute [Authorize(Roles = "Admin,Manager")]
@inject IStationService StationService
@inject IJSRuntime JS
@inject LocalizationStateService LocalizationState
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>@GetText("station.page_title", "Quản lý Trạm")</PageTitle>

<style>
    /* Fix DevExpress spin button size */
    @* .dxbl-spin-btn,
    .dxbl-btn {
        width: 20px !important;
        height: 20px !important;
        min-width: 20px !important;
        min-height: 20px !important;
        padding: 2px !important;
    }
    
    /* Fix SVG icons inside buttons */
    .dxbl-spin-btn svg,
    .dxbl-btn svg,
    button svg {
        width: 12px !important;
        height: 12px !important;
        max-width: 12px !important;
        max-height: 12px !important;
    }
    
    /* Fix filter row controls */
    .dxbs-filter-row input,
    .dxbs-filter-row .dxbl-edit-container {
        height: 32px !important;
        font-size: 13px !important;
    }
    
    /* Fix spin edit in filter row */
    .dxbs-filter-row .dxbl-spin-edit {
        height: 32px !important;
    }
    
    .dxbs-filter-row .dxbl-spin-edit input {
        padding: 4px 8px !important;
    }
    
    /* Fix grid header and cells */
    .dxbs-grid td,
    .dxbs-grid th {
        padding: 8px 12px !important;
        font-size: 14px !important;
    } *@
</style>

<!-- Page Heading -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">@GetText("station.page_title", "Quản lý Trạm")</h1>
    <AuthorizeView Roles="Admin">
        <button class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" @onclick="ShowAddModal">
            <i class="fas fa-plus fa-sm text-white-50"></i> @GetText("station.add_button", "Thêm Trạm Mới")
        </button>
    </AuthorizeView>
</div>

<!-- DevExpress DataGrid -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">@GetText("station.list_title", "Danh sách Trạm")</h6>
    </div>
    <div class="card-body">
        <DxGrid @ref="Grid"
                    Data="@InstantFeedbackSource" 
                    PageSize="20"
                    ShowPager="true"
                    PagerNavigationMode="PagerNavigationMode.InputBox"
                    PageSizeSelectorVisible="true"
                    AllowSelectRowByClick="false"
                    HighlightRowOnHover="true"
                    TextWrapEnabled="false"
                    FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
                    @bind-SearchText="@SearchText"
                    ColumnResizeMode="GridColumnResizeMode.NextColumn"
                    SizeMode="SizeMode.Medium">
                <Columns>
                    <DxGridDataColumn FieldName="Id" Caption="ID" Visible="false" />
                    <DxGridDataColumn FieldName="StationCode" Caption="@StationCodeColumnCaption" Width="120px" />
                    <DxGridDataColumn FieldName="Name" Caption="@NameColumnCaption" MinWidth="150" />
                    <DxGridDataColumn FieldName="Description" Caption="@DescriptionColumnCaption" Visible="false" />
                    <DxGridDataColumn FieldName="Address" Caption="@AddressColumnCaption" MinWidth="200" />
                    <DxGridDataColumn FieldName="ContactPerson" Caption="@ContactColumnCaption" Width="150px" />
                    <DxGridDataColumn FieldName="ContactPhone" Caption="@PhoneColumnCaption" Width="150" />
                    <DxGridDataColumn FieldName="IsActive" Caption="@MonitoringStatusColumnCaption" Width="150">
                        <CellDisplayTemplate>
                            @{
                                var isActive = (bool)context.Value;
                            }
                            @if (isActive)
                            {
                                <span class="badge badge-success">
                                    <i class="fas fa-check-circle"></i> @GetText("station.monitoring_active", "Đang giám sát")
                                </span>
                            }
                            else
                            {
                                <span class="badge badge-secondary">
                                    <i class="fas fa-pause-circle"></i> @GetText("station.monitoring_inactive", "Tạm dừng")
                                </span>
                            }
                        </CellDisplayTemplate>
                    </DxGridDataColumn>
                    <DxGridDataColumn FieldName="CreatedAt" Caption="@CreatedAtColumnCaption" DisplayFormat="dd/MM/yyyy" Visible="false" />
                    <DxGridDataColumn FieldName="ModifiedAt" Caption="@ModifiedAtColumnCaption" DisplayFormat="dd/MM/yyyy" Visible="false" />

                    <DxGridDataColumn FieldName="Id" Caption="@GetText("station.actions_column", "Thao tác")" Width="225px" AllowSort="false">
                        <CellDisplayTemplate>
                            @{
                                var stationId = (Guid)context.Value;
                            }
                            <div class="d-flex justify-content-center gap-1">
                                <button class="btn btn-primary btn-sm" title="@GetText("station.config_monitoring_tooltip", "Cấu hình giám sát")" @onclick="@(() => ShowTimeFramesModalAsync(stationId))">
                                    <i class="fas fa-clock"></i>
                                </button>
                                <button class="btn btn-info btn-sm" title="Xem lịch sử thay đổi" @onclick="@(() => ShowAuditLog(stationId))">
                                    <i class="fas fa-history"></i>
                                </button>
                                <AuthorizeView Roles="Admin" Context="authContext">
                                    <button class="btn btn-warning btn-sm" title="@GetText("station.edit_tooltip", "Chỉnh sửa")" @onclick="@(() => ShowEditModalAsync(stationId))">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" title="@GetText("station.delete_tooltip", "Xóa")" @onclick="@(() => DeleteStation(stationId))">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </AuthorizeView>
                            </div>
                        </CellDisplayTemplate>
                    </DxGridDataColumn>
                </Columns>
                <ToolbarTemplate>
                    <DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">
                        <Items>
                            <DxToolbarItem BeginGroup="true" Alignment="ToolbarItemAlignment.Right">
                                <Template Context="toolbarContext">
                                    <DxTextBox @bind-Text="@SearchText" 
                                               ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                               NullText="@GetText("station.search_placeholder", "Tìm kiếm trạm...")"
                                               ShowValidationIcon="false"
                                               style="width: 300px;"
                                               @onkeydown:stopPropagation="true">
                                    </DxTextBox>
                                </Template>
                            </DxToolbarItem>
                        </Items>
                    </DxToolbar>
                </ToolbarTemplate>
            </DxGrid>
    </div>
</div>

<!-- Add/Edit Modal -->
<DxPopup @bind-Visible="@showModal"
         HeaderText="@(editingStation == null ? GetText("station.edit_title_add", "Thêm Trạm Mới") : GetText("station.edit_title_edit", "Chỉnh sửa Trạm"))"
         ShowCloseButton="true"
         Width="600px"
         MaxWidth="90%"
         Height="auto"
         MaxHeight="90vh"
         CloseOnOutsideClick="false">
    <BodyContentTemplate Context="popupContext">
        <EditForm Model="stationForm" OnValidSubmit="SaveStation" Context="formContext">
            <DataAnnotationsValidator />
            
            <!-- Scrollable Form Content -->
            <div style="max-height: calc(90vh - 150px); overflow-y: auto; padding: 1.5rem;">
                <DxFormLayout CssClass="w-100">
                @if (editingStation != null)
                {
                    <DxFormLayoutItem Caption="@GetText("station.code_label", "Mã Trạm")" ColSpanMd="12" CaptionPosition="CaptionPosition.Vertical">
                        <Template>
                            <DxTextBox @bind-Text="@editingStation.StationCode" 
                                       ReadOnly="true"
                                       CssClass="bg-light form-control-sm">
                            </DxTextBox>
                            <small class="form-text text-muted mt-1 d-block">@GetText("station.code_readonly_note", "Mã trạm tự động sinh ra và không thể chỉnh sửa")</small>
                        </Template>
                    </DxFormLayoutItem>
                }
                
                <DxFormLayoutItem Caption="@GetText("station.name_label", "Tên Trạm")" ColSpanMd="12" CaptionPosition="CaptionPosition.Vertical">
                    <Template>
                        <DxTextBox @bind-Text="@stationForm.Name" 
                                   NullText="@GetText("station.name_placeholder", "Nhập tên trạm")"
                                   ShowValidationIcon="true"
                                   CssClass="form-control">
                        </DxTextBox>
                        <ValidationMessage For="@(() => stationForm.Name)" />
                    </Template>
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="@GetText("station.address_label", "Địa chỉ")" ColSpanMd="12" CaptionPosition="CaptionPosition.Vertical">
                    <Template>
                        <DxTextBox @bind-Text="@stationForm.Address" 
                                   NullText="@GetText("station.address_placeholder", "Nhập địa chỉ")"
                                   CssClass="form-control">
                        </DxTextBox>
                    </Template>
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="@GetText("station.description_label", "Mô tả")" ColSpanMd="12" CaptionPosition="CaptionPosition.Vertical">
                    <Template>
                        <DxMemo @bind-Text="@stationForm.Description"
                                Rows="3"
                                NullText="@GetText("station.description_placeholder", "Nhập mô tả")"
                                CssClass="form-control">
                        </DxMemo>
                    </Template>
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="@GetText("station.contact_label", "Người liên hệ")" ColSpanMd="6" CaptionPosition="CaptionPosition.Vertical">
                    <Template>
                        <DxTextBox @bind-Text="@stationForm.ContactPerson" 
                                   NullText="@GetText("station.contact_placeholder", "Tên người liên hệ")"
                                   CssClass="form-control">
                        </DxTextBox>
                    </Template>
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="@GetText("station.phone_label", "Điện thoại")" ColSpanMd="6" CaptionPosition="CaptionPosition.Vertical">
                    <Template>
                        <DxMaskedInput @bind-Value="@stationForm.ContactPhone"
                                       Mask="0000-000-000"
                                       NullText="@GetText("station.phone_placeholder", "Nhập số điện thoại")"
                                       ShowValidationIcon="true"
                                       CssClass="form-control">
                        </DxMaskedInput>
                        <ValidationMessage For="@(() => stationForm.ContactPhone)" />
                    </Template>
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="@GetText("station.active_label", "Trạng thái hoạt động")" ColSpanMd="12" CaptionPosition="CaptionPosition.Vertical">
                    <Template>
                        <div class="form-check">
                            <DxCheckBox @bind-Checked="@stationForm.IsActive" 
                                        CssClass="form-check-input" />
                        </div>
                    </Template>
                </DxFormLayoutItem>
            </DxFormLayout>
            </div>
            
            <!-- Fixed Footer Buttons -->
            <div class="border-top p-3 bg-light d-flex justify-content-end gap-2">
                <DxButton Text="@GetText("button.cancel", "Hủy")" 
                          RenderStyle="ButtonRenderStyle.Secondary"
                          Click="@CloseModal" />
                <DxButton Text="@GetText("button.save", "Lưu")" 
                          RenderStyle="ButtonRenderStyle.Primary"
                          RenderStyleMode="ButtonRenderStyleMode.Contained"
                          SubmitFormOnClick="true"
                          IconCssClass="fas fa-save" />
            </div>
        </EditForm>
    </BodyContentTemplate>
</DxPopup>

<!-- TimeFrame Configuration Modal -->
@if (showTimeFramesModal)
{
    <TimeFrameConfigModal 
        StationId="@selectedStationId"
        @bind-Visible="@showTimeFramesModal" />
}

@code {
    private bool showModal = false;
    private Station? editingStation = null;
    private StationFormModel stationForm = new();
    
    // TimeFrames modal fields
    private bool showTimeFramesModal = false;
    private Guid selectedStationId = Guid.Empty;
    private string selectedStationName = string.Empty;
    
    // Prevent multiple modals opening simultaneously
    private bool isModalOperationInProgress = false;
    
    // Server Mode properties
    IGrid Grid { get; set; } = null!;
    EntityInstantFeedbackSource InstantFeedbackSource { get; set; } = null!;
    string SearchText = string.Empty;

    // Column captions - reactive properties  
    private string StationCodeColumnCaption => GetText("station.code_column", "Mã Trạm");
    private string NameColumnCaption
    {
        get
        {
            var text = GetText("station.name_column", "Tên Trạm");
            Console.WriteLine($"[Stations] NameColumnCaption: key='station.name_column', IsLoaded={LocalizationState?.IsLoaded}, result='{text}'");
            return text;
        }
    }
    private string DescriptionColumnCaption => GetText("station.description_column", "Mô tả");
    private string AddressColumnCaption => GetText("station.address_column", "Địa chỉ");
    private string ContactColumnCaption => GetText("station.contact_column", "Người liên hệ");
    private string PhoneColumnCaption => GetText("station.phone_column", "Điện thoại");
    private string MonitoringStatusColumnCaption => GetText("station.monitoring_status_column", "Trạng thái giám sát");
    private string StatusColumnCaption => GetText("station.status_column", "Trạng thái");
    private string CreatedAtColumnCaption => GetText("station.created_column", "Ngày tạo");
    private string ModifiedAtColumnCaption => GetText("station.modified_column", "Ngày cập nhật");

    private bool _hasInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("[Stations.OnInitializedAsync] START");
        
        // Detect browser language
        string browserLanguage = "vi";
        try
        {
            var detected = await JS.InvokeAsync<string>("eval", "navigator.language || navigator.userLanguage");
            Console.WriteLine($"[Stations] Detected browser language: {detected}");
            
            if (detected.StartsWith("vi"))
                browserLanguage = "vi";
            else if (detected.StartsWith("en"))
                browserLanguage = "en";
            else
                browserLanguage = "vi";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Stations] Error detecting language: {ex.Message}");
            browserLanguage = "vi";
        }
        
        // Load from localStorage if exists
        try
        {
            var savedLanguage = await JS.InvokeAsync<string>("localStorage.getItem", "preferredLanguage");
            if (!string.IsNullOrEmpty(savedLanguage))
            {
                browserLanguage = savedLanguage;
                Console.WriteLine($"[Stations] Loaded language from localStorage: {browserLanguage}");
            }
        }
        catch { }
        
        // Initialize LocalizationState
        Console.WriteLine($"[Stations] Initializing LocalizationState with language: {browserLanguage}");
        await LocalizationState.InitializeAsync(browserLanguage);
        Console.WriteLine($"[Stations] LocalizationState initialized - IsLoaded={LocalizationState.IsLoaded}");
        
        // Initialize InstantFeedbackSource for server-side data
        var stationService = ScopedServices.GetRequiredService<IStationService>();
        InstantFeedbackSource = new EntityInstantFeedbackSource(e => {
            e.KeyExpression = nameof(Station.Id);
            e.QueryableSource = stationService.GetStationsQueryable();
        });
        
        Console.WriteLine("[Stations.OnInitializedAsync] DONE");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_hasInitialized)
        {
            _hasInitialized = true;
            Console.WriteLine($"[Stations.OnAfterRenderAsync] Triggering StateHasChanged for translations");
            StateHasChanged();
        }
    }

    private void ShowAddModal()
    {
        if (isModalOperationInProgress) return;
        
        try
        {
            isModalOperationInProgress = true;
            
            // Reset state
            editingStation = null;
            stationForm = new StationFormModel { IsActive = true };
            
            // Open add modal
            showModal = true;
        }
        finally
        {
            isModalOperationInProgress = false;
        }
    }

    private async Task ShowEditModalAsync(Guid stationId)
    {
        if (isModalOperationInProgress) return;
        
        try
        {
            isModalOperationInProgress = true;
            
            // Close edit modal
            showModal = false;
            
            var station = await StationService.GetStationByIdAsync(stationId);
            if (station != null)
            {
                editingStation = station;
                stationForm = new StationFormModel
                {
                    Name = station.Name,
                    Address = station.Address,
                    Description = station.Description,
                    ContactPerson = station.ContactPerson,
                    ContactPhone = station.ContactPhone,
                    IsActive = station.IsActive
                };
                showModal = true;
            }
        }
        finally
        {
            isModalOperationInProgress = false;
        }
    }

    private void CloseModal()
    {
        showModal = false;
        editingStation = null;
        stationForm = new StationFormModel { IsActive = true };
    }

    private async Task SaveStation()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userName = authState.User.Identity?.Name ?? "System";
            
            if (editingStation == null)
            {
                // Create new
                var newStation = new Station
                {
                    Name = stationForm.Name,
                    Address = stationForm.Address,
                    Description = stationForm.Description,
                    ContactPerson = stationForm.ContactPerson,
                    ContactPhone = stationForm.ContactPhone,
                    IsActive = stationForm.IsActive,
                    CreatedBy = userName,
                    CreatedAt = DateTime.UtcNow
                };
                await StationService.CreateStationAsync(newStation);
                await JS.InvokeVoidAsync("showToast", "Tạo trạm thành công", "success", 3000);
            }
            else
            {
                // Update existing
                editingStation.Name = stationForm.Name;
                editingStation.Address = stationForm.Address;
                editingStation.Description = stationForm.Description;
                editingStation.ContactPerson = stationForm.ContactPerson;
                editingStation.ContactPhone = stationForm.ContactPhone;
                editingStation.IsActive = stationForm.IsActive;
                editingStation.ModifiedBy = userName;
                editingStation.ModifiedAt = DateTime.UtcNow;
                await StationService.UpdateStationAsync(editingStation.Id, editingStation);
                await JS.InvokeVoidAsync("showToast", "Cập nhật trạm thành công", "success", 3000);
            }

            CloseModal();
            
            // Refresh grid after modal closes - force reload from database
            await Task.Delay(100);
            
            // Recreate InstantFeedbackSource to force data reload
            var stationService = ScopedServices.GetRequiredService<IStationService>();
            InstantFeedbackSource?.Dispose();
            InstantFeedbackSource = new EntityInstantFeedbackSource(e => {
                e.KeyExpression = nameof(Station.Id);
                e.QueryableSource = stationService.GetStationsQueryable();
            });
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"{GetText("message.error", "Lỗi")}: {ex.Message}");
        }
    }

    private async Task DeleteStation(Guid stationId)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", GetText("message.confirm_delete_station", "Bạn có chắc chắn muốn xóa trạm này?"));
        if (confirmed)
        {
            try
            {
                // Close TimeFrames modal if it's open for this station
                if (showTimeFramesModal && selectedStationId == stationId)
                {
                    showTimeFramesModal = false;
                    selectedStationId = Guid.Empty;
                    selectedStationName = string.Empty;
                }
                
                await StationService.DeleteStationAsync(stationId);
                
                // Recreate InstantFeedbackSource to force data reload
                var stationService = ScopedServices.GetRequiredService<IStationService>();
                InstantFeedbackSource?.Dispose();
                InstantFeedbackSource = new EntityInstantFeedbackSource(e => {
                    e.KeyExpression = nameof(Station.Id);
                    e.QueryableSource = stationService.GetStationsQueryable();
                });
                
                StateHasChanged();
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"{GetText("message.delete_error", "Lỗi khi xóa")}: {ex.Message}");
            }
        }
    }


    private void ShowAuditLog(Guid stationId)
    {
        // Navigate to reports page with station filter
        Navigation.NavigateTo($"/reports?tab=audit&entityType=Station&entityId={stationId}");
    }

    private async Task ShowCamerasModalAsync(Guid stationId)
    {
        if (isModalOperationInProgress) return;
        
        try
        {
            isModalOperationInProgress = true;
            
            // Close all other modals first
            showModal = false;
            showTimeFramesModal = false;
            selectedStationId = Guid.Empty;
            selectedStationName = string.Empty;
            
            // TODO: Navigate to camera assignment page
            await Task.CompletedTask;
        }
        finally
        {
            isModalOperationInProgress = false;
        }
    }

    private async Task ShowTimeFramesModalAsync(Guid stationId)
    {
        if (isModalOperationInProgress) return;
        
        try
        {
            isModalOperationInProgress = true;
            
            // Close all other modals first
            showModal = false;
            editingStation = null;
            
            var station = await StationService.GetStationByIdAsync(stationId);
            if (station != null)
            {
                selectedStationId = stationId;
                selectedStationName = station.Name;
                showTimeFramesModal = true;
            }
        }
        finally
        {
            isModalOperationInProgress = false;
        }
    }

    public void Dispose()
    {
        InstantFeedbackSource?.Dispose();
    }

    public class StationFormModel
    {
        [Required(ErrorMessage = "Tên trạm là bắt buộc")]
        [MaxLength(200)]
        public string Name { get; set; } = string.Empty;

        [MaxLength(500)]
        public string? Address { get; set; }

        [MaxLength(1000)]
        public string? Description { get; set; }

        [MaxLength(100)]
        public string? ContactPerson { get; set; }

        [RegularExpression(@"^[\d\-]+$", ErrorMessage = "Số điện thoại không hợp lệ")]
        [MaxLength(20)]
        public string? ContactPhone { get; set; }

        public bool IsActive { get; set; } = true;
    }

    private Station? GetStationFromContext(GridDataColumnCellDisplayTemplateContext context)
    {
        try
        {
            var dataItem = context.DataItem;
            return dataItem as Station;
        }
        catch
        {
            return null;
        }
    }

    private string GetText(string key, string defaultText)
    {
        try
        {
            if (LocalizationState?.IsLoaded == true)
            {
                var translation = LocalizationState[key];
                Console.WriteLine($"[GetText] key='{key}', translation='{translation}', IsLoaded={LocalizationState.IsLoaded}, CurrentLanguage={LocalizationState.CurrentLanguage}");
                return !string.IsNullOrEmpty(translation) && translation != key ? translation : defaultText;
            }
            else
            {
                Console.WriteLine($"[GetText] key='{key}', LocalizationState={LocalizationState != null}, IsLoaded={LocalizationState?.IsLoaded}, using default='{defaultText}'");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[GetText] Error: {ex.Message}, Stack: {ex.StackTrace}");
        }
        return defaultText;
    }
}