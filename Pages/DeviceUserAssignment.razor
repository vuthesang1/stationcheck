@page "/device-user-assignment"
@using Microsoft.AspNetCore.Components.Authorization
@using StationCheck.Models
@using Microsoft.EntityFrameworkCore
@using StationCheck.Data
@using DeviceUserAssignmentModel = StationCheck.Models.DeviceUserAssignment
@attribute [Authorize(Roles = "Admin,Manager")]
@inject HttpClient Http
@inject IJSRuntime JS
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2>
                <i class="fas fa-link mr-2"></i>
                @GetText("device_assignment_title", "Quản lý quyền truy cập thiết bị")
            </h2>
            <small class="text-muted">@GetText("device_assignment_desc", "Chỉ định người dùng có thể đăng nhập từ thiết bị nào")</small>
        </div>
    </div>

    <!-- Assignment Rules Info -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>@GetText("device_rules_title", "Quy tắc truy cập:"):</strong>
                        <ul class="mt-2 mb-0">
                            <li>@GetText("device_rule1", "Người dùng chỉ có thể đăng nhập từ thiết bị được gán cho họ")</li>
                            <li>@GetText("device_rule2", "Admin có thể đăng nhập từ bất kỳ thiết bị nào (override)")</li>
                            <li>@GetText("device_rule3", "Khi thiết bị được duyệt, người dùng đăng ký tự động được gán")</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Approved Devices Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-check-circle mr-2"></i>
                                @GetText("device_approved_devices", "Thiết bị đã được duyệt")
                            </h6>
                        </div>
                        <div class="card-body">
                            @if (isLoadingDevices)
                            {
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">@GetText("common_loading", "Đang tải...")</span>
                                    </div>
                                </div>
                            }
                            else if (approvedDevices.Count == 0)
                            {
                                <div class="alert alert-info">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    @GetText("device_no_approved", "Không có thiết bị đã được duyệt.")
                                </div>
                            }
                            else
                            {
                                <DxGrid Data="@approvedDevices"
                                            PageSize="10"
                                            ShowPager="true"
                                            PagerNavigationMode="PagerNavigationMode.InputBox"
                                            AllowSelectRowByClick="false"
                                            HighlightRowOnHover="true"
                                            TextWrapEnabled="false"
                                            FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
                                            ColumnResizeMode="GridColumnResizeMode.NextColumn">
                                    <Columns>
                                        <DxGridDataColumn FieldName="DeviceName" Caption="@GetText("device_name", "Tên thiết bị")" MinWidth="150" />
                                        <DxGridDataColumn FieldName="OwnerUsername" Caption="@GetText("device_owner", "Chủ sở hữu")" Width="120px" />
                                        <DxGridDataColumn FieldName="AssignedUsersCount" Caption="@GetText("device_assigned_users", "Người dùng được gán")" Width="100px">
                                            <CellDisplayTemplate>
                                                @{
                                                    var dev = (DeviceAssignmentDto)context.DataItem;
                                                }
                                                <span class="badge badge-primary">@dev.AssignedUsersCount</span>
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                        <DxGridDataColumn FieldName="LastUsedAt" Caption="@GetText("device_last_used", "Lần cuối sử dụng")" Width="120px">
                                            <CellDisplayTemplate>
                                                @{
                                                    var dev = (DeviceAssignmentDto)context.DataItem;
                                                }
                                                @if (dev.LastUsedAt.HasValue)
                                                {
                                                    <span>@dev.LastUsedAt.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">@GetText("device_never_used", "Chưa sử dụng")</span>
                                                }
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                        <DxGridDataColumn FieldName="DeviceId" Caption="@GetText("common_actions", "Thao tác")" Width="100px" AllowSort="false">
                                            <CellDisplayTemplate>
                                                @{
                                                    var dev = (DeviceAssignmentDto)context.DataItem;
                                                }
                                                <button class="btn btn-sm btn-primary"
                                                        title="@GetText("device_manage_users", "Quản lý người dùng")"
                                                        @onclick="() => ShowManageUsers(dev)">
                                                    <i class="fas fa-users"></i>
                                                </button>
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                    </Columns>
                                </DxGrid>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Users Modal -->
            <DxPopup @bind-Visible="@showManageUsersModal"
                     HeaderText="@GetText("device_manage_assigned_users", "Quản lý người dùng được gán cho thiết bị")"
                     Width="700px"
                     MaxHeight="80vh">
                <Content>
                    @if (selectedDevice != null)
                    {
                        <div class="mb-3">
                            <h6>@selectedDevice.DeviceName</h6>
                            <small class="text-muted">@GetText("device_owner", "Chủ sở hữu"): @selectedDevice.OwnerUsername</small>
                        </div>

                        <div class="alert alert-warning mb-3" role="alert">
                            <small>
                                <i class="fas fa-info-circle mr-1"></i>
                                @GetText("device_admin_override_note", "Lưu ý: Admin luôn có thể đăng nhập từ bất kỳ thiết bị nào, không cần gán đặc biệt.")
                            </small>
                        </div>

                        <div class="mb-3">
                            <h6>@GetText("device_assigned_users_list", "Người dùng được gán")</h6>
                            @if (assignedUsers.Count > 0)
                            {
                                <div class="list-group">
                                    @foreach (var user in assignedUsers)
                                    {
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>@user.Username</span>
                                            @if (user.Username != selectedDevice.OwnerUsername)
                                            {
                                                <button class="btn btn-sm btn-danger"
                                                        @onclick="() => RemoveUserAssignment(user.UserId)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            }
                                            else
                                            {
                                                <span class="badge badge-success">@GetText("device_owner", "Chủ sở hữu")</span>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info small">
                                    @GetText("device_no_assigned_users", "Chưa có người dùng được gán.")
                                </div>
                            }
                        </div>

                        <div class="mb-3">
                            <h6>@GetText("device_add_user", "Thêm người dùng")</h6>
                            <div class="input-group">
                                <select class="custom-select" @bind="selectedUserId">
                                    <option value="">@GetText("device_select_user", "-- Chọn người dùng --")</option>
                                    @foreach (var user in availableUsers)
                                    {
                                        <option value="@user.Id">@user.Username (@user.FullName)</option>
                                    }
                                </select>
                                <div class="input-group-append">
                                    <button class="btn btn-primary" type="button" @onclick="AddUserAssignment">
                                        <i class="fas fa-plus mr-1"></i>@GetText("common_add", "Thêm")
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="text-right mt-4">
                            <button class="btn btn-secondary" @onclick="() => showManageUsersModal = false">
                                @GetText("common_close", "Đóng")
                            </button>
                        </div>
                    }
                </Content>
            </DxPopup>
    </div>

@code {
    private class DeviceAssignmentDto
    {
        public Guid DeviceId { get; set; }
        public string DeviceName { get; set; } = string.Empty;
        public string OwnerUsername { get; set; } = string.Empty;
        public int AssignedUsersCount { get; set; }
        public DateTime? LastUsedAt { get; set; }
    }

    private class UserDto
    {
        public string Id { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
    }

    private class AssignedUserDto
    {
        public string UserId { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
    }

    private List<DeviceAssignmentDto> approvedDevices = new();
    private List<UserDto> availableUsers = new();
    private List<AssignedUserDto> assignedUsers = new();
    private DeviceAssignmentDto? selectedDevice;
    private string? selectedUserId;
    private bool showManageUsersModal = false;
    private bool isLoadingDevices = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadApprovedDevices();
    }

    private async Task LoadApprovedDevices()
    {
        try
        {
            isLoadingDevices = true;
            await using var context = DbContextFactory.CreateDbContext();
            var devices = await context.UserDevices
                .Where(d => d.IsApproved && !d.IsDeleted)
                .Include(d => d.Assignments!)
                .ThenInclude(a => a.User)
                .Select(d => new DeviceAssignmentDto
                {
                    DeviceId = d.Id,
                    DeviceName = d.DeviceName,
                    OwnerUsername = d.Assignments != null && d.Assignments.Any(a => a.IsActive) 
                        ? (d.Assignments.First(a => a.IsActive).User != null ? d.Assignments.First(a => a.IsActive).User!.Username : "Unknown")
                        : "(Unassigned)",
                    AssignedUsersCount = d.Assignments != null ? d.Assignments.Count(a => a.IsActive) : 0,
                    LastUsedAt = d.LastUsedAt
                })
                .ToListAsync();
            approvedDevices = devices;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading devices: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
        }
        finally
        {
            isLoadingDevices = false;
        }
    }

    private async Task ShowManageUsers(DeviceAssignmentDto device)
    {
        selectedDevice = device;
        selectedUserId = null;
        assignedUsers.Clear();
        availableUsers.Clear();

        try
        {
            await using var context = DbContextFactory.CreateDbContext();
            
            // Load assigned users for this device
            var dbDevice = await context.UserDevices
                .Include(d => d.Assignments!)
                .ThenInclude(a => a.User)
                .FirstOrDefaultAsync(d => d.Id == device.DeviceId);
            
            if (dbDevice?.Assignments != null)
            {
                assignedUsers = dbDevice.Assignments
                    .Where(a => a.IsActive)
                    .Select(a => new AssignedUserDto
                    {
                        UserId = a.UserId,
                        Username = a.User != null ? a.User.Username : "Unknown"
                    })
                    .ToList();
            }
            
            // Load available users (all non-admin users not yet assigned)
            var assignedUserIds = assignedUsers.Select(u => u.UserId).ToList();
            
            availableUsers = await context.Users
                .Where(u => !u.IsDeleted && !assignedUserIds.Contains(u.Id))
                .Select(u => new UserDto
                {
                    Id = u.Id,
                    Username = u.Username,
                    FullName = u.FullName
                })
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading users: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
        }

        showManageUsersModal = true;
    }

    private async Task AddUserAssignment()
    {
        if (string.IsNullOrEmpty(selectedUserId) || selectedDevice == null)
            return;

        try
        {
            await using var context = DbContextFactory.CreateDbContext();
            
            // Create new assignment
            var assignment = new DeviceUserAssignmentModel
            {
                DeviceId = selectedDevice.DeviceId,
                UserId = selectedUserId,
                IsActive = true,
                AssignedAt = DateTime.UtcNow
            };
            
            context.DeviceUserAssignments.Add(assignment);
            await context.SaveChangesAsync();
            
            await LoadApprovedDevices();
            await ShowManageUsers(selectedDevice);
            await JS.InvokeVoidAsync("alert", "Người dùng đã được gán cho thiết bị.");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
        }
    }

    private async Task RemoveUserAssignment(string userId)
    {
        if (selectedDevice == null)
            return;

        if (await JS.InvokeAsync<bool>("confirm", "Bạn có chắc muốn xóa gán này?"))
        {
            try
            {
                await using var context = DbContextFactory.CreateDbContext();
                
                var assignment = await context.DeviceUserAssignments
                    .FirstOrDefaultAsync(a => a.DeviceId == selectedDevice.DeviceId && a.UserId == userId);
                
                if (assignment != null)
                {
                    assignment.IsActive = false;
                    context.DeviceUserAssignments.Update(assignment);
                    await context.SaveChangesAsync();
                    
                    await ShowManageUsers(selectedDevice);
                    await JS.InvokeVoidAsync("alert", "Người dùng đã được xóa khỏi thiết bị.");
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Không tìm thấy gán này.");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
            }
        }
    }

    private string GetText(string key, string defaultValue)
    {
        // TODO: Implement localization from service
        return defaultValue;
    }
}
