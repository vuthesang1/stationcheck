@page "/device-registration"
@using Microsoft.AspNetCore.Components.Authorization
@using StationCheck.Models
@attribute [Authorize]
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-laptop-house mr-2"></i>
                @GetText("device_registration_title", "Quản lý thiết bị")
            </h2>
        </div>
    </div>

            <!-- Download Installer Section -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h5 class="m-0">
                                <i class="fas fa-download mr-2"></i>
                                @GetText("device_download_installer", "Tải xuống Installer")
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">
                                @GetText("device_installer_description", "Tải xuống công cụ cài đặt để đăng ký thiết bị của bạn. Công cụ sẽ tạo chứng chỉ tự ký và gửi thông tin đăng ký lên hệ thống.")
                            </p>
                            <button class="btn btn-primary btn-lg btn-block" @onclick="DownloadInstaller">
                                <i class="fas fa-download mr-2"></i>
                                @GetText("device_download_button", "Tải Installer")
                            </button>
                            <small class="d-block mt-3 text-muted">
                                <strong>@GetText("device_instructions", "Hướng dẫn:"):</strong>
                                <ol class="mt-2">
                                    <li>@GetText("device_step1", "Tải xuống file installer")</li>
                                    <li>@GetText("device_step2", "Chạy file .exe")</li>
                                    <li>@GetText("device_step3", "Nhập tên thiết bị của bạn")</li>
                                    <li>@GetText("device_step4", "Ấn nút 'Đăng ký' để hoàn thành")</li>
                                    <li>@GetText("device_step5", "Chờ admin duyệt thiết bị")</li>
                                </ol>
                            </small>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-header bg-info text-white">
                            <h5 class="m-0">
                                <i class="fas fa-info-circle mr-2"></i>
                                @GetText("device_requirements", "Yêu cầu")
                            </h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="fas fa-check text-success mr-2"></i>
                                    @GetText("device_req_windows", "Windows 7 trở lên")
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success mr-2"></i>
                                    @GetText("device_req_net", ".NET Runtime (bao gồm trong installer)")
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success mr-2"></i>
                                    @GetText("device_req_internet", "Kết nối internet")
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success mr-2"></i>
                                    @GetText("device_req_admin", "Quyền Administrator (để cài đặt chứng chỉ)")
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registered Devices Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-list mr-2"></i>
                                @GetText("device_registered_devices", "Thiết bị đã đăng ký")
                            </h6>
                        </div>
                        <div class="card-body">
                            @if (isLoadingDevices)
                            {
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">@GetText("common_loading", "Đang tải...")</span>
                                    </div>
                                </div>
                            }
                            else if (userDevices == null || userDevices.Count == 0)
                            {
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    @GetText("device_no_devices", "Bạn chưa đăng ký thiết bị nào. Tải xuống installer ở trên để bắt đầu.")
                                </div>
                            }
                            else
                            {
                                <DxGrid Data="@userDevices"
                                            PageSize="10"
                                            ShowPager="true"
                                            PagerNavigationMode="PagerNavigationMode.InputBox"
                                            AllowSelectRowByClick="false"
                                            HighlightRowOnHover="true"
                                            TextWrapEnabled="false"
                                            FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
                                            ColumnResizeMode="GridColumnResizeMode.NextColumn">
                                    <Columns>
                                        <DxGridDataColumn FieldName="DeviceName" Caption="@GetText("device_name", "Tên thiết bị")" MinWidth="150" />
                                        <DxGridDataColumn FieldName="CertificateSubject" Caption="@GetText("device_certificate_cn", "Certificate CN")" MinWidth="200" />
                                        <DxGridDataColumn FieldName="CertificateValidFrom" Caption="@GetText("device_valid_from", "Hiệu lực từ")" Width="120px" DisplayFormat="dd/MM/yyyy" />
                                        <DxGridDataColumn FieldName="CertificateValidTo" Caption="@GetText("device_valid_to", "Hết hạn")" Width="120px" DisplayFormat="dd/MM/yyyy" />
                                        <DxGridDataColumn FieldName="IsApproved" Caption="@GetText("device_status", "Trạng thái")" Width="100px">
                                            <CellDisplayTemplate>
                                                @{
                                                    var dev = (UserDeviceDto)context.DataItem;
                                                    string badgeClass = dev.IsRevoked ? "badge-danger"
                                                        : dev.IsApproved ? "badge-success"
                                                        : "badge-warning";
                                                    string statusText = dev.IsRevoked ? GetText("device_revoked", "Thu hồi")
                                                        : dev.IsApproved ? GetText("device_approved", "Được duyệt")
                                                        : GetText("device_pending", "Chờ duyệt");
                                                }
                                                <span class="badge @badgeClass">@statusText</span>
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                        <DxGridDataColumn FieldName="LastUsedAt" Caption="@GetText("device_last_used", "Lần cuối sử dụng")" Width="140px">
                                            <CellDisplayTemplate>
                                                @{
                                                    var dev = (UserDeviceDto)context.DataItem;
                                                }
                                                @if (dev.LastUsedAt.HasValue)
                                                {
                                                    <span>@dev.LastUsedAt.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">@GetText("device_never_used", "Chưa sử dụng")</span>
                                                }
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                        <DxGridDataColumn FieldName="CreatedAt" Caption="@GetText("device_registered_date", "Ngày đăng ký")" Width="140px" DisplayFormat="dd/MM/yyyy HH:mm" />
                                        <DxGridDataColumn FieldName="Id" Caption="@GetText("common_actions", "Thao tác")" Width="150px" AllowSort="false">
                                            <CellDisplayTemplate>
                                                @{
                                                    var dev = (UserDeviceDto)context.DataItem;
                                                }
                                                <div class="d-flex justify-content-center gap-1">
                                                    <button class="btn btn-sm btn-info" title="@GetText("device_view_details", "Xem chi tiết")" @onclick="() => ShowDeviceDetails(dev)">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    @if (!dev.IsRevoked)
                                                    {
                                                        <button class="btn btn-sm btn-danger" title="@GetText("device_revoke", "Thu hồi")" @onclick="() => ConfirmRevoke(dev)">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    }
                                                </div>
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                    </Columns>
                                </DxGrid>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Details Modal -->
        <DxPopup @bind-Visible="@showDetailsModal"
                 HeaderText="@GetText("device_details", "Chi tiết thiết bị")"
                 Width="600px">
            <Content>
                @if (selectedDevice != null)
                {
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>@GetText("device_name", "Tên thiết bị"):</strong>
                            <p>@selectedDevice.DeviceName</p>
                        </div>
                        <div class="col-md-6">
                            <strong>@GetText("device_status", "Trạng thái"):</strong>
                            <p>
                                @{
                                    string badgeClass = selectedDevice.IsRevoked ? "badge-danger"
                                        : selectedDevice.IsApproved ? "badge-success"
                                        : "badge-warning";
                                    string statusText = selectedDevice.IsRevoked ? GetText("device_revoked", "Thu hồi")
                                        : selectedDevice.IsApproved ? GetText("device_approved", "Được duyệt")
                                        : GetText("device_pending", "Chờ duyệt");
                                }
                                <span class="badge @badgeClass">@statusText</span>
                            </p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <strong>@GetText("device_thumbprint", "Thumbprint"):</strong>
                            <p><code>@selectedDevice.CertificateThumbprint</code></p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <strong>@GetText("device_certificate_subject", "Certificate Subject"):</strong>
                            <p>@selectedDevice.CertificateSubject</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>@GetText("device_valid_from", "Hiệu lực từ"):</strong>
                            <p>@selectedDevice.CertificateValidFrom.ToString("dd/MM/yyyy HH:mm:ss")</p>
                        </div>
                        <div class="col-md-6">
                            <strong>@GetText("device_valid_to", "Hết hạn"):</strong>
                            <p>@selectedDevice.CertificateValidTo.ToString("dd/MM/yyyy HH:mm:ss")</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>@GetText("device_registered_date", "Ngày đăng ký"):</strong>
                            <p>@selectedDevice.CreatedAt.ToString("dd/MM/yyyy HH:mm:ss")</p>
                        </div>
                        <div class="col-md-6">
                            <strong>@GetText("device_approved_date", "Ngày duyệt"):</strong>
                            <p>@(selectedDevice.ApprovedAt?.ToString("dd/MM/yyyy HH:mm:ss") ?? GetText("device_not_approved_yet", "Chưa được duyệt"))</p>
                        </div>
                    </div>

                    @if (selectedDevice.LastUsedAt.HasValue)
                    {
                        <div class="row mb-3">
                            <div class="col-12">
                                <strong>@GetText("device_last_used", "Lần cuối sử dụng"):</strong>
                                <p>@selectedDevice.LastUsedAt.Value.ToString("dd/MM/yyyy HH:mm:ss")</p>
                            </div>
                        </div>
                    }

                    <div class="text-right mt-4">
                        <button class="btn btn-secondary" @onclick="() => showDetailsModal = false">
                            @GetText("common_close", "Đóng")
                        </button>
                    </div>
                }
        </Content>
    </DxPopup>

@code {
    private List<UserDeviceDto> userDevices = new();
    private UserDeviceDto? selectedDevice;
    private bool showDetailsModal = false;
    private bool isLoadingDevices = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserDevices();
    }

    private async Task LoadUserDevices()
    {
        try
        {
            isLoadingDevices = true;
            userDevices = await Http.GetFromJsonAsync<List<UserDeviceDto>>("api/auth/user-devices") ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading devices: {ex.Message}");
        }
        finally
        {
            isLoadingDevices = false;
        }
    }

    private async Task DownloadInstaller()
    {
        try
        {
            // Download DeviceInstaller.exe from wwwroot
            await JS.InvokeVoidAsync("open", "/DeviceInstaller.exe", "_blank");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading installer: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"Lỗi tải xuống: {ex.Message}");
        }
    }

    private void ShowDeviceDetails(UserDeviceDto device)
    {
        selectedDevice = device;
        showDetailsModal = true;
    }

    private async Task ConfirmRevoke(UserDeviceDto device)
    {
        if (await JS.InvokeAsync<bool>("confirm", $"Bạn có chắc muốn thu hồi thiết bị '{device.DeviceName}'?"))
        {
            await RevokeDevice(device.Id);
        }
    }

    private async Task RevokeDevice(Guid deviceId)
    {
        try
        {
            var response = await Http.PostAsync($"api/auth/revoke-device/{deviceId}", null);
            if (response.IsSuccessStatusCode)
            {
                await LoadUserDevices();
                await JS.InvokeVoidAsync("alert", "Thiết bị đã được thu hồi.");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Lỗi: {error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
        }
    }

    private string GetText(string key, string defaultValue)
    {
        // TODO: Implement localization from service
        return defaultValue;
    }
}
