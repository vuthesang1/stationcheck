@page "/"
@namespace StationCheck.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using Microsoft.AspNetCore.Components.Web

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="~/" />
    <title>StationCheck - Water Monitoring System</title>
    
    <!-- Custom fonts for SB Admin 2 -->
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- SB Admin 2 CSS (Bootstrap 4) -->
    <link href="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin-2@4.1.4/css/sb-admin-2.min.css" rel="stylesheet">
    
    <!-- DevExpress Blazor CSS for Bootstrap 4 -->
    <link href="_content/DevExpress.Blazor.Themes/blazing-berry.bs4.min.css" rel="stylesheet" />
    
    <link href="css/site.css?v=5" rel="stylesheet" />
    <component type="typeof(HeadOutlet)" render-mode="Server" />
</head>
<body>
    <component type="typeof(App)" render-mode="Server" />

    <div id="blazor-error-ui">
        An error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ðŸ—™</a>
    </div>
    
    <script src="_framework/blazor.server.js"></script>
    
    <!-- SignalR for real-time notifications -->
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    
    <!-- SweetAlert2 for beautiful popups -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap core JavaScript-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SB Admin 2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin-2@4.1.4/js/sb-admin-2.min.js"></script>
    
    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Global 401 Unauthorized Handler - MUST load before other scripts -->
    <script src="~/js/401-handler.js"></script>
    
    <!-- Custom scripts -->
    <script src="~/js/helpers.js"></script>
    <script src="~/js/reports.js"></script>
    <!-- Toast helper -->
    <script src="~/js/toast-helper.js"></script>
    <!-- Device Auth Manager - Force logout on device revoke/removal -->
    <script src="~/js/deviceAuth.js"></script>
    <!-- Device Status Monitor - Real-time notifications -->
    <script src="~/js/device-status-monitor.js"></script>
    
    <script>
        // Auto-login from localStorage token (Desktop App flow)
        (async function() {
            // Skip auto-login on callback page (it handles authentication itself)
            if (window.location.pathname === '/desktop-login-callback') {
                console.log('[AutoLogin] Skipping auto-login on callback page');
                return;
            }
            
            const authToken = localStorage.getItem('authToken');
            if (authToken && window.location.pathname !== '/login') {
                console.log('[AutoLogin] Found authToken in localStorage, validating...');
                
                try {
                    // Validate token with API
                    const response = await fetch('/api/auth/validate-token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('[AutoLogin] Token valid, user:', data.username);
                        
                        // Set authentication cookie for Blazor Server
                        const cookieResponse = await fetch('/api/auth/set-cookie-from-token', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        });
                        
                        if (cookieResponse.ok) {
                            console.log('[AutoLogin] Authentication cookie set, reloading page...');
                            
                            // Store token for API calls
                            localStorage.setItem('jwt_token', authToken);
                            sessionStorage.setItem('jwt_token', authToken);
                            
                            // Store user info
                            if (data.user) {
                                localStorage.setItem('user_info', JSON.stringify(data.user));
                            }
                            
                            // Reload to activate Blazor authentication
                            window.location.reload();
                        } else {
                            console.warn('[AutoLogin] Failed to set cookie, clearing tokens...');
                            localStorage.removeItem('authToken');
                            localStorage.removeItem('jwt_token');
                            sessionStorage.removeItem('jwt_token');
                        }
                        
                        // Page will auto-refresh via Blazor
                    } else {
                        console.warn('[AutoLogin] Token invalid, clearing...');
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('jwt_token');
                        sessionStorage.removeItem('jwt_token');
                    }
                } catch (error) {
                    console.error('[AutoLogin] Error validating token:', error);
                }
            }
        })();
    
        window.getLocation = async () => {
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject);
                });
                
                return {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
            } catch (error) {
                console.error('Error getting location:', error);
                return null;
            }
        };

        // Handle 401 Unauthorized responses - force logout
        window.handleUnauthorized = async () => {
            console.log('[AccessControl] 401 Unauthorized - calling logout endpoint');
            
            try {
                // Call logout endpoint to revoke tokens server-side
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                }).catch(e => console.warn('Logout endpoint error:', e));
            } catch (e) {
                console.warn('Error calling logout:', e);
            }
            
            // Clear client-side tokens
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user_info');
            localStorage.removeItem('refresh_token');
            
            // Redirect to login
            console.log('[AccessControl] Redirecting to /login');
            window.location.href = '/login';
        };

        // List of paths that should bypass 401 handling (anonymous endpoints)
        const anonymousPaths = [
            '/login',
            '/api/auth/login',
            '/api/auth/web-login',
            '/api/auth/register',
            '/api/auth/refresh',
            '/api/auth/download-installer',
            '/swagger',
            '/api/docs'
        ];

        // Check if path is anonymous/public
        function isAnonymousPath(url) {
            try {
                const urlObj = new URL(url, window.location.origin);
                const path = urlObj.pathname.toLowerCase();
                return anonymousPaths.some(p => path.startsWith(p.toLowerCase()));
            } catch {
                return false;
            }
        }

        // Monitor fetch responses for 401 errors
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            return originalFetch.apply(this, args).then(response => {
                // Only handle 401 for authorized endpoints
                if (response.status === 401 && !isAnonymousPath(url)) {
                    console.warn('Received 401 Unauthorized response from', url);
                    window.handleUnauthorized();
                }
                return response;
            });
        };
    </script>
</body>
</html>