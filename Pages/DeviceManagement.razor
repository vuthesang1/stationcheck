@page "/device-management"
@using Microsoft.AspNetCore.Components.Authorization
@using StationCheck.Models
@using Microsoft.EntityFrameworkCore
@using StationCheck.Data
@using Microsoft.JSInterop
@implements IAsyncDisposable
@inject ILogger<DeviceManagement> Logger
@inject NavigationManager Navigation
@using DeviceUserAssignmentModel = StationCheck.Models.DeviceUserAssignment
@attribute [Authorize(Roles = "Admin,Manager")]
@inject HttpClient Http
@inject IJSRuntime JS
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IForceLogoutService ForceLogoutService
@inject StationCheck.Services.IDeviceAuthService DeviceAuthService

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2>
                <i class="fas fa-tablet-alt mr-2"></i>
                @GetText("device_management_title", "Qu·∫£n l√Ω thi·∫øt b·ªã")
            </h2>
            <small class="text-muted">@GetText("device_management_desc", "Qu·∫£n l√Ω duy·ªát, ch·ªânh s·ª≠a v√† g√°n ng∆∞·ªùi d√πng cho  thi·∫øt b·ªã")</small>
        </div>
    </div>

    <!-- Tabs -->
    <div class="row mb-3">
        <div class="col-12">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "approved" ? "active" : "")"
                        @onclick="@(() => SwitchTab("approved"))" type="button" role="tab">
                        <i class="fas fa-check-circle mr-2"></i>
                        @GetText("device_approved_devices", "Thi·∫øt b·ªã ƒë√£ duy·ªát")
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "pending" ? "active" : "")"
                        @onclick="@(() => SwitchTab("pending"))" type="button" role="tab">
                        <i class="fas fa-hourglass-half mr-2"></i>
                        @GetText("device_pending_approvals", "Ch·ªù duy·ªát")
                        @if (pendingDevices.Count > 0)
                        {
                            <span class="badge badge-danger">  @pendingDevices.Count</span>
                        }
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Approved Devices Tab -->
        @if (activeTab == "approved")
        {
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-check-circle mr-2"></i>
                                @GetText("device_approved_devices", "Thi·∫øt b·ªã ƒë√£ duy·ªát")
                            </h6>
                        </div>
                        <div class="card-body">
                            @if (isLoadingApproved)
                            {
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">@GetText("common_loading", "ƒêang t·∫£i...")</span>
                                    </div>
                                </div>
                            }
                            else if (approvedDevices.Count == 0)
                            {
                                <div class="alert alert-info">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    @GetText("device_no_approved", "Kh√¥ng c√≥ thi·∫øt b·ªã ƒë√£ ƒë∆∞·ª£c duy·ªát.")
                                </div>
                            }
                            else
                            {
                                <DxGrid Data="@approvedDevices" PageSize="10" ShowPager="true"
                                    PagerNavigationMode="PagerNavigationMode.InputBox" AllowSelectRowByClick="false"
                                    HighlightRowOnHover="true" TextWrapEnabled="false"
                                    FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
                                    ColumnResizeMode="GridColumnResizeMode.NextColumn">
                                    <Columns>
                                        <DxGridDataColumn FieldName="DeviceName"
                                            Caption="@GetText("device_name", "T√™n thi·∫øt b·ªã")" MinWidth="150" />
                                        <DxGridDataColumn FieldName="MacAddress"
                                            Caption="@GetText("device_mac_address", "MAC Address")" Width="150px" />
                                        <DxGridDataColumn FieldName="IsRevoked"
                                            Caption="@GetText("device_status", "Tr·∫°ng th√°i")" Width="120px">
                                            <CellDisplayTemplate>
                                                @{
                                                    var dev = (ApprovedDeviceDto)context.DataItem;
                                                }
                                                @if (dev.IsRevoked)
                                                {
                                                    <span class="badge badge-danger">@GetText("device_revoked", "ƒê√£ v√¥ hi·ªáu")</span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-success">@GetText("device_active", "ƒêang ho·∫°t ƒë·ªông")</span>
                                                }
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                        <DxGridDataColumn FieldName="AssignedUsersCount"
                                            Caption="@GetText("device_assigned_users", "Ng∆∞·ªùi d√πng ƒë∆∞·ª£c g√°n")" Width="100px">
                                            <CellDisplayTemplate>
                                                @{
                                                    var dev = (ApprovedDeviceDto)context.DataItem;
                                                }
                                                <span class="badge badge-primary">@dev.AssignedUsersCount</span>
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                        <DxGridDataColumn FieldName="CertificateValidTo"
                                            Caption="@GetText("device_valid_to", "H·∫øt h·∫°n")" Width="120px"
                                            DisplayFormat="dd/MM/yyyy" />
                                        <DxGridDataColumn FieldName="ApprovedAt"
                                            Caption="@GetText("device_approved_date", "Ng√†y duy·ªát")" Width="150px"
                                            DisplayFormat="dd/MM/yyyy HH:mm">
                                            <CellDisplayTemplate>
                                                @{
                                                    var dev = (ApprovedDeviceDto)context.DataItem;
                                                }
                                                @if (dev.ApprovedAt.HasValue)
                                                {
                                                    <span>@dev.ApprovedAt.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                                }
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                        <DxGridDataColumn FieldName="ApprovedBy"
                                            Caption="@GetText("device_approved_by", "Ng∆∞·ªùi duy·ªát")" Width="120px" />
                                        <DxGridDataColumn FieldName="LastUsedAt"
                                            Caption="@GetText("device_last_used", "L·∫ßn cu·ªëi s·ª≠ d·ª•ng")" Width="120px">
                                            <CellDisplayTemplate>
                                                @{
                                                    var dev = (ApprovedDeviceDto)context.DataItem;
                                                }
                                                @if (dev.LastUsedAt.HasValue)
                                                {
                                                    <span>@dev.LastUsedAt.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">@GetText("device_never_used", "Ch∆∞a s·ª≠ d·ª•ng")</span>
                                                }
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                        <DxGridDataColumn FieldName="DeviceId" Caption="@GetText("common_actions", "Thao t√°c")"
                                            Width="126px" AllowSort="false">
                                            <CellDisplayTemplate>
                                                @{
                                                    var dev = (ApprovedDeviceDto)context.DataItem;
                                                }
                                                @if (dev.IsRevoked)
                                                {
                                                    <button class="btn btn-sm btn-success mr-1"
                                                        title="@GetText("device_reactivate", "K√≠ch ho·∫°t l·∫°i")"
                                                        @onclick="@(() => ReactivateDevice(dev))">
                                                        <i class="fas fa-redo"></i>
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-sm btn-info mr-1"
                                                        title="@GetText("device_edit", "Ch·ªânh s·ª≠a")"
                                                        @onclick="@(() => ShowEditModal(dev))">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                }
                                                <button class="btn btn-sm btn-danger" title="@GetText("device_delete", "X√≥a")"
                                                    @onclick="@(() => DeleteDevice(dev))">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                    </Columns>
                                </DxGrid>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Pending Devices Tab -->
        @if (activeTab == "pending")
        {
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-hourglass-half mr-2"></i>
                                @GetText("device_pending_approvals", "Ch·ªù ph√™ duy·ªát") (@pendingDevices.Count)
                            </h6>
                        </div>
                        <div class="card-body">
                            @if (isLoadingPending)
                            {
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">@GetText("common_loading", "ƒêang t·∫£i...")</span>
                                    </div>
                                </div>
                            }
                            else if (pendingDevices.Count == 0)
                            {
                                <div class="alert alert-info">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    @GetText("device_no_pending", "Kh√¥ng c√≥ thi·∫øt b·ªã ch·ªù ph√™ duy·ªát.")
                                </div>
                            }
                            else
                            {
                                <DxGrid Data="@pendingDevices" PageSize="10" ShowPager="true"
                                    PagerNavigationMode="PagerNavigationMode.InputBox" AllowSelectRowByClick="false"
                                    HighlightRowOnHover="true" TextWrapEnabled="false"
                                    FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
                                    ColumnResizeMode="GridColumnResizeMode.NextColumn">
                                    <Columns>
                                        <DxGridDataColumn FieldName="DeviceName"
                                            Caption="@GetText("device_name", "T√™n thi·∫øt b·ªã")" MinWidth="150" />
                                        <DxGridDataColumn FieldName="MacAddress"
                                            Caption="@GetText("device_mac_address", "MAC Address")" Width="150px" />
                                        <DxGridDataColumn FieldName="CertificateValidFrom"
                                            Caption="@GetText("device_valid_from", "Hi·ªáu l·ª±c t·ª´")" Width="120px"
                                            DisplayFormat="dd/MM/yyyy" />
                                        <DxGridDataColumn FieldName="CertificateValidTo"
                                            Caption="@GetText("device_valid_to", "H·∫øt h·∫°n")" Width="120px"
                                            DisplayFormat="dd/MM/yyyy" />
                                        <DxGridDataColumn FieldName="CreatedAt"
                                            Caption="@GetText("device_registered_date", "Ng√†y ƒëƒÉng k√Ω")" Width="150px"
                                            DisplayFormat="dd/MM/yyyy HH:mm" />
                                        <DxGridDataColumn FieldName="Id" Caption="@GetText("common_actions", "Thao t√°c")"
                                            Width="180px" AllowSort="false">
                                            <CellDisplayTemplate>
                                                @{
                                                    var dev = (PendingDeviceDto)context.DataItem;
                                                }
                                                <button class="btn btn-sm btn-success mr-1"
                                                    title="@GetText("device_approve", "Duy·ªát")"
                                                    @onclick="@(() => ApproveDevice(dev))">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger"
                                                    title="@GetText("device_reject", "T·ª´ ch·ªëi")"
                                                    @onclick="@(() => RejectDevice(dev))">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                    </Columns>
                                </DxGrid>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Edit Device Modal -->
    <DxPopup @bind-Visible="@showEditModal" HeaderText="@GetText("device_edit_title", "Ch·ªânh s·ª≠a thi·∫øt b·ªã")"
        Width="900px" MaxHeight="80vh">
        <Content>
            @if (selectedApprovedDevice != null)
            {
                <!-- Tabs within Modal -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link @(editModalTab == "info" ? "active" : "")"
                            @onclick="@(() => editModalTab = "info")" type="button">
                            <i class="fas fa-info-circle mr-2"></i>
                            @GetText("device_info", "Th√¥ng tin thi·∫øt b·ªã")
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link @(editModalTab == "users" ? "active" : "")"
                            @onclick="@(() => editModalTab = "users")" type="button">
                            <i class="fas fa-users mr-2"></i>
                            @GetText("device_assign_users", "Qu·∫£n l√Ω ng∆∞·ªùi d√πng")
                        </button>
                    </li>
                </ul>

                <!-- Device Info Tab -->
                @if (editModalTab == "info")
                {
                    <div class="tab-pane fade show active">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Ng∆∞·ªùi d√πng ƒë∆∞·ª£c g√°n:</strong> @selectedApprovedDevice.AssignedUsersList
                        </div>
                        <div class="form-group mb-3">
                            <label>@GetText("device_name", "T√™n thi·∫øt b·ªã")</label>
                            <input type="text" class="form-control" @bind="editFormModel.DeviceName" />
                        </div>
                        <div class="form-group mb-3">
                            <label>@GetText("device_thumbprint", "Thumbprint")</label>
                            <input type="text" class="form-control" @bind="editFormModel.CertificateThumbprint" readonly />
                        </div>

                        <div class="form-group mb-3">
                            <label>@GetText("device_certificate_subject", "Certificate Subject")</label>
                            <input type="text" class="form-control" @bind="editFormModel.CertificateSubject" readonly />
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label>@GetText("device_valid_from", "Hi·ªáu l·ª±c t·ª´")</label>
                                    <input type="text" class="form-control"
                                        value="@editFormModel.CertificateValidFrom.ToString("dd/MM/yyyy HH:mm:ss")" readonly />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label>@GetText("device_valid_to", "H·∫øt h·∫°n")</label>
                                    <input type="text" class="form-control"
                                        value="@editFormModel.CertificateValidTo.ToString("dd/MM/yyyy HH:mm:ss")" readonly />
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label>@GetText("device_approved_by", "Ng∆∞·ªùi duy·ªát")</label>
                                    <input type="text" class="form-control" value="@editFormModel.ApprovedBy" readonly />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label>@GetText("device_approved_date", "Ng√†y duy·ªát")</label>
                                    <input type="text" class="form-control"
                                        value="@(editFormModel.ApprovedAt?.ToString("dd/MM/yyyy HH:mm:ss") ?? "")" readonly />
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-info-circle mr-2"></i>
                            @GetText("device_edit_warning", "Ch·ªâ c√≥ th·ªÉ ch·ªânh s·ª≠a t√™n thi·∫øt b·ªã. C√°c th√¥ng tin kh√°c l√† ch·ªâ ƒë·ªçc.")
                        </div>

                        <div class="text-right">
                            <button class="btn btn-secondary mr-2" @onclick="@(() => showEditModal = false)">
                                @GetText("common_cancel", "H·ªßy")
                            </button>
                            <button class="btn btn-danger mr-2" @onclick="DeactivateDevice">
                                <i class="fas fa-ban mr-1"></i>@GetText("device_deactivate", "V√¥ hi·ªáu h√≥a")
                            </button>
                            <button class="btn btn-primary" @onclick="SaveDeviceChanges">
                                <i class="fas fa-save mr-1"></i>@GetText("common_save", "L∆∞u")
                            </button>
                        </div>
                    </div>
                }

                <!-- Users Management Tab -->
                @if (editModalTab == "users")
                {
                    <div class="tab-pane fade show active">
                        <div class="mb-3">
                            <h6>@GetText("device_assigned_users_list", "Ng∆∞·ªùi d√πng ƒë∆∞·ª£c g√°n")</h6>
                            @if (assignedUsers.Count > 0)
                            {
                                <div class="list-group mb-3">
                                    @foreach (var user in assignedUsers)
                                    {
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>@user.Username</span>
                                            <button class="btn btn-sm btn-danger" @onclick="@(() => RemoveUserAssignment(user.UserId))">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info small">
                                    @GetText("device_no_assigned_users", "Ch∆∞a c√≥ ng∆∞·ªùi d√πng ƒë∆∞·ª£c g√°n.")
                                </div>
                            }
                        </div>

                        <div class="mb-3">
                            <h6>@GetText("device_add_user", "Th√™m ng∆∞·ªùi d√πng")</h6>
                            <div class="input-group">
                                <select class="custom-select" @bind="selectedUserId">
                                    <option value="">@GetText("device_select_user", "-- Ch·ªçn ng∆∞·ªùi d√πng --")</option>
                                    @foreach (var user in availableUsers)
                                    {
                                        <option value="@user.Id">@user.Username (@user.FullName)</option>
                                    }
                                </select>
                                <div class="input-group-append">
                                    <button class="btn btn-primary" type="button" @onclick="AddUserAssignment">
                                        <i class="fas fa-plus mr-1"></i>@GetText("common_add", "Th√™m")
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info small">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>L∆∞u √Ω:</strong> Admin lu√¥n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p t·ª´ b·∫•t k·ª≥ thi·∫øt b·ªã n√†o. Khi user b·ªã remove kh·ªèi
                            thi·∫øt b·ªã, h·ªç s·∫Ω b·ªã logout ngay l·∫≠p t·ª©c.
                        </div>

                        <div class="text-right mt-4">
                            <button class="btn btn-secondary" @onclick="@(() => showEditModal = false)">
                                @GetText("common_close", "ƒê√≥ng")
                            </button>
                        </div>
                    </div>
                }
            }
        </Content>
    </DxPopup>
</div>

@code {
    // Data Transfer Objects
    private class PendingDeviceDto
    {
        public Guid Id { get; set; }
        public string DeviceName { get; set; } = string.Empty;
        public string MacAddress { get; set; } = string.Empty;
        public string CertificateThumbprint { get; set; } = string.Empty;
        public string CertificateSubject { get; set; } = string.Empty;
        public DateTime CertificateValidFrom { get; set; }
        public DateTime CertificateValidTo { get; set; }
        public DateTime CreatedAt { get; set; }
    }

    private class ApprovedDeviceDto
    {
        public Guid DeviceId { get; set; }
        public string DeviceName { get; set; } = string.Empty;
        public string MacAddress { get; set; } = string.Empty;
        public string AssignedUsersList { get; set; } = string.Empty;
        public int AssignedUsersCount { get; set; }
        public bool IsRevoked { get; set; }
        public DateTime? LastUsedAt { get; set; }
        public DateTime? ApprovedAt { get; set; }
        public string? ApprovedBy { get; set; }
        public DateTime CertificateValidTo { get; set; }
    }

    private class UserDto
    {
        public string Id { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
    }

    private class AssignedUserDto
    {
        public string UserId { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
    }

    private class EditDeviceFormModel
    {
        public Guid Id { get; set; }
        public string DeviceName { get; set; } = string.Empty;
        public string MacAddress { get; set; } = string.Empty;
        public string CertificateThumbprint { get; set; } = string.Empty;
        public string CertificateSubject { get; set; } = string.Empty;
        public DateTime CertificateValidFrom { get; set; }
        public DateTime CertificateValidTo { get; set; }
        public string? ApprovedBy { get; set; }
        public DateTime? ApprovedAt { get; set; }
    }

    // State
    private string activeTab = "approved";
    private string editModalTab = "info";
    private Timer? _accessCheckTimer;
    private bool _logoutInProgress = false;

    private List<ApprovedDeviceDto> approvedDevices = new();
    private List<PendingDeviceDto> pendingDevices = new();
    private List<UserDto> availableUsers = new();
    private List<AssignedUserDto> assignedUsers = new();

    private ApprovedDeviceDto? selectedApprovedDevice;
    private EditDeviceFormModel editFormModel = new();
    private string? selectedUserId;

    private bool showEditModal = false;
    private bool isLoadingApproved = true;
    private bool isLoadingPending = true;

    protected override async Task OnInitializedAsync()
    {
        // Ki·ªÉm tra xem user hi·ªán t·∫°i c√≥ quy·ªÅn truy c·∫≠p thi·∫øt b·ªã kh√¥ng
        await CheckUserAccessAndLogoutIfNeeded();

        await LoadAllData();

        // Kh·ªüi ƒë·ªông timer ki·ªÉm tra quy·ªÅn truy c·∫≠p m·ªói 3 gi√¢y
        if (_accessCheckTimer == null)
        {
            _accessCheckTimer = new Timer(async _ =>
            {
                await CheckUserAccessAndLogoutIfNeeded();
            }, null, TimeSpan.FromSeconds(60), TimeSpan.FromSeconds(60));
        }
    }

    private async Task CheckUserAccessAndLogoutIfNeeded()
    {
        // Prevent showing alert multiple times
        if (_logoutInProgress)
            return;

        // DISABLED: ForceLogoutService certificate checking (causes refresh loop for browser SSO)
        // Certificate-based device validation is handled by AccessControlMiddleware with MAC address
        // try
        // {
        //     var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        //     var user = authState.User;
        //
        //     await ForceLogoutService.CheckAndLogoutIfNeededAsync(
        //     user,
        //     DbContextFactory,
        //     Http,
        //     Navigation,
        //     JS,
        //     Logger,
        //     _accessCheckTimer);
        //
        //     _logoutInProgress = true;
        // }
        // catch (Exception ex)
        // {
        //     Logger.LogError(ex, $"[DeviceManagement] Access check error: {ex.Message}");
        // }
    }

    private async Task LoadAllData()
    {
        await Task.WhenAll(
        LoadApprovedDevices(),
        LoadPendingDevices()
        );
    }

    private async Task SwitchTab(string tab)
    {
        activeTab = tab;
        if (tab == "approved" && approvedDevices.Count == 0)
        {
            await LoadApprovedDevices();
        }
        else if (tab == "pending" && pendingDevices.Count == 0)
        {
            await LoadPendingDevices();
        }
    }

    private async Task LoadApprovedDevices()
    {
        try
        {
            isLoadingApproved = true;
            await using var context = DbContextFactory.CreateDbContext();
            var devices = await context.UserDevices
            .Where(d => d.IsApproved && !d.IsDeleted)  // Show both active and revoked approved devices
            .Include(d => d.Assignments!)
            .ThenInclude(a => a.User)
            .Select(d => new ApprovedDeviceDto
            {
                DeviceId = d.Id,
                DeviceName = d.DeviceName,
                MacAddress = d.MacAddress ?? "N/A",
                AssignedUsersList = d.Assignments != null && d.Assignments.Any(a => a.IsActive)
            ? string.Join(", ", d.Assignments.Where(a => a.IsActive).Select(a => a.User != null ? a.User.Username : "Unknown"))
            : "(Ch∆∞a g√°n)",
                AssignedUsersCount = d.Assignments != null ? d.Assignments.Count(a => a.IsActive) : 0,
                IsRevoked = d.IsRevoked,
                LastUsedAt = d.LastUsedAt,
                ApprovedAt = d.ApprovedAt,
                ApprovedBy = d.ApprovedBy,
                CertificateValidTo = d.CertificateValidTo
            })
            .ToListAsync();
            approvedDevices = devices;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading approved devices: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"L·ªói: {ex.Message}");
        }
        finally
        {
            isLoadingApproved = false;
        }
    }

    private async Task LoadPendingDevices()
    {
        try
        {
            isLoadingPending = true;
            await using var context = DbContextFactory.CreateDbContext();
            var devices = await context.UserDevices
            .Where(d => !d.IsApproved && !d.IsRevoked && !d.IsDeleted)
            .Select(d => new PendingDeviceDto
            {
                Id = d.Id,
                DeviceName = d.DeviceName,
                MacAddress = d.MacAddress ?? "N/A",
                CertificateThumbprint = d.CertificateThumbprint,
                CertificateSubject = d.CertificateSubject,
                CertificateValidFrom = d.CertificateValidFrom,
                CertificateValidTo = d.CertificateValidTo,
                CreatedAt = d.CreatedAt
            })
            .ToListAsync();
            pendingDevices = devices;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading pending devices: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"L·ªói: {ex.Message}");
        }
        finally
        {
            isLoadingPending = false;
        }
    }

    private async Task ShowEditModal(ApprovedDeviceDto device)
    {
        selectedApprovedDevice = device;
        selectedUserId = null;
        assignedUsers.Clear();
        availableUsers.Clear();
        editModalTab = "info";

        try
        {
            await using var context = DbContextFactory.CreateDbContext();

            // Load device details for edit form
            var dbDevice = await context.UserDevices
            .FirstOrDefaultAsync(d => d.Id == device.DeviceId);

            if (dbDevice != null)
            {
                editFormModel = new EditDeviceFormModel
                {
                    Id = dbDevice.Id,
                    DeviceName = dbDevice.DeviceName,
                    CertificateThumbprint = dbDevice.CertificateThumbprint,
                    CertificateSubject = dbDevice.CertificateSubject,
                    CertificateValidFrom = dbDevice.CertificateValidFrom,
                    CertificateValidTo = dbDevice.CertificateValidTo,
                    ApprovedBy = dbDevice.ApprovedBy,
                    ApprovedAt = dbDevice.ApprovedAt
                };
            }

            // Load assigned users for this device
            var dbDeviceWithAssignments = await context.UserDevices
            .Include(d => d.Assignments!)
            .ThenInclude(a => a.User)
            .FirstOrDefaultAsync(d => d.Id == device.DeviceId);

            if (dbDeviceWithAssignments?.Assignments != null)
            {
                assignedUsers = dbDeviceWithAssignments.Assignments
                .Where(a => a.IsActive)
                .Select(a => new AssignedUserDto
                {
                    UserId = a.UserId,
                    Username = a.User != null ? a.User.Username : "Unknown"
                })
                .ToList();
            }

            // Load available users
            var assignedUserIds = assignedUsers.Select(u => u.UserId).ToList();
            availableUsers = await context.Users
            .Where(u => !u.IsDeleted && !assignedUserIds.Contains(u.Id))
            .Select(u => new UserDto
            {
                Id = u.Id,
                Username = u.Username,
                FullName = u.FullName
            })
            .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading device details: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"L·ªói: {ex.Message}");
        }

        showEditModal = true;
    }

    private async Task SaveDeviceChanges()
    {
        try
        {
            await using var context = DbContextFactory.CreateDbContext();
            var dbDevice = await context.UserDevices.FirstOrDefaultAsync(d => d.Id == editFormModel.Id);

            if (dbDevice != null)
            {
                dbDevice.DeviceName = editFormModel.DeviceName;
                context.UserDevices.Update(dbDevice);
                await context.SaveChangesAsync();

                await LoadApprovedDevices();
                showEditModal = false;
                await JS.InvokeVoidAsync("alert", "Thi·∫øt b·ªã ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"L·ªói: {ex.Message}");
        }
    }

    private async Task DeactivateDevice()
    {
        if (await JS.InvokeAsync<bool>("confirm", "B·∫°n c√≥ ch·∫Øc mu·ªën v√¥ hi·ªáu h√≥a thi·∫øt b·ªã n√†y? Ng∆∞·ªùi d√πng s·∫Ω kh√¥ng th·ªÉ s·ª≠ d·ª•ng n√≥."))
        {
            try
            {
                await using var context = DbContextFactory.CreateDbContext();
                var dbDevice = await context.UserDevices.FirstOrDefaultAsync(d => d.Id == editFormModel.Id);

                if (dbDevice != null)
                {
                    dbDevice.IsRevoked = true;
                    context.UserDevices.Update(dbDevice);
                    await context.SaveChangesAsync();

                    // üî• Force logout t·∫•t c·∫£ user ƒëang d√πng device n√†y
                    await DeviceAuthService.NotifyDeviceRevokedAsync(editFormModel.Id);
                    Logger.LogWarning($"[DeactivateDevice] Device {editFormModel.Id} revoked. Force logout triggered.");

                    // Refresh grid v√† ƒë√≥ng modal
                    await LoadApprovedDevices();
                    showEditModal = false;

                    // Ki·ªÉm tra xem c√≥ employee n√†o ƒëang d√πng thi·∫øt b·ªã n√†y kh√¥ng
                    var activeAssignments = await context.DeviceUserAssignments
                        .Include(a => a.User)
                        .Where(a => a.DeviceId == editFormModel.Id && a.IsActive)
                        .ToListAsync();

                    if (activeAssignments.Any())
                    {
                        var usernames = string.Join(", ", activeAssignments.Select(a => a.User?.Username ?? "Unknown"));
                        await JS.InvokeVoidAsync("alert", 
                            $"Thi·∫øt b·ªã ƒë√£ ƒë∆∞·ª£c v√¥ hi·ªáu h√≥a th√†nh c√¥ng. T·∫•t c·∫£ user ƒëang d√πng thi·∫øt b·ªã n√†y s·∫Ω b·ªã force logout.");
                    }
                    else
                    {
                        await JS.InvokeVoidAsync("alert", "Thi·∫øt b·ªã ƒë√£ ƒë∆∞·ª£c v√¥ hi·ªáu h√≥a th√†nh c√¥ng.");
                    }
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"L·ªói: {ex.Message}");
            }
        }
    }

    private async Task DeleteDevice(ApprovedDeviceDto device)
    {
        if (await JS.InvokeAsync<bool>("confirm", $"B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a thi·∫øt b·ªã '{device.DeviceName}'? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c."))
        {
            try
            {
                await using var context = DbContextFactory.CreateDbContext();
                var dbDevice = await context.UserDevices.FirstOrDefaultAsync(d => d.Id == device.DeviceId);

                if (dbDevice != null)
                {
                    dbDevice.IsDeleted = true;
                    context.UserDevices.Update(dbDevice);
                    await context.SaveChangesAsync();

                    await LoadApprovedDevices();
                    await JS.InvokeVoidAsync("alert", "Thi·∫øt b·ªã ƒë√£ ƒë∆∞·ª£c x√≥a.");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"L·ªói: {ex.Message}");
            }
        }
    }

    private async Task ApproveDevice(PendingDeviceDto device)
    {
        try
        {
            await using var context = DbContextFactory.CreateDbContext();
            var dbDevice = await context.UserDevices.FirstOrDefaultAsync(d => d.Id == device.Id);

            if (dbDevice != null)
            {
                dbDevice.IsApproved = true;
                dbDevice.IsRevoked = false;
                dbDevice.ApprovedAt = DateTime.UtcNow;
                dbDevice.ApprovedBy = "Admin"; // TODO: Get current user

                context.UserDevices.Update(dbDevice);
                await context.SaveChangesAsync();

                await LoadAllData();
                await JS.InvokeVoidAsync("alert", $"Thi·∫øt b·ªã '{device.DeviceName}' ƒë√£ ƒë∆∞·ª£c duy·ªát.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"L·ªói: {ex.Message}");
        }
    }

    private async Task RejectDevice(PendingDeviceDto device)
    {
        if (await JS.InvokeAsync<bool>("confirm", $"B·∫°n c√≥ ch·∫Øc mu·ªën t·ª´ ch·ªëi thi·∫øt b·ªã '{device.DeviceName}'?"))
        {
            try
            {
                await using var context = DbContextFactory.CreateDbContext();
                var dbDevice = await context.UserDevices.FirstOrDefaultAsync(d => d.Id == device.Id);

                if (dbDevice != null)
                {
                    dbDevice.IsRevoked = true;
                    dbDevice.IsApproved = false;
                    context.UserDevices.Update(dbDevice);
                    await context.SaveChangesAsync();

                    await LoadAllData();
                    await JS.InvokeVoidAsync("alert", $"Thi·∫øt b·ªã '{device.DeviceName}' ƒë√£ b·ªã t·ª´ ch·ªëi.");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"L·ªói: {ex.Message}");
            }
        }
    }

    private async Task ReactivateDevice(ApprovedDeviceDto device)
    {
        if (await JS.InvokeAsync<bool>("confirm", $"B·∫°n c√≥ ch·∫Øc mu·ªën k√≠ch ho·∫°t l·∫°i thi·∫øt b·ªã '{device.DeviceName}'?"))
        {
            try
            {
                await using var context = DbContextFactory.CreateDbContext();
                var dbDevice = await context.UserDevices.FirstOrDefaultAsync(d => d.Id == device.DeviceId);

                if (dbDevice != null)
                {
                    dbDevice.IsRevoked = false;
                    context.UserDevices.Update(dbDevice);
                    await context.SaveChangesAsync();

                    await LoadApprovedDevices();
                    await JS.InvokeVoidAsync("alert", $"Thi·∫øt b·ªã '{device.DeviceName}' ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t l·∫°i.");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"L·ªói: {ex.Message}");
            }
        }
    }

    private async Task AddUserAssignment()
    {
        if (string.IsNullOrEmpty(selectedUserId) || selectedApprovedDevice == null)
            return;

        try
        {
            await using var context = DbContextFactory.CreateDbContext();

            // Ki·ªÉm tra xem assignment ƒë√£ t·ªìn t·∫°i hay ch∆∞a
            var existingAssignment = await context.DeviceUserAssignments
            .FirstOrDefaultAsync(a => a.DeviceId == selectedApprovedDevice.DeviceId
            && a.UserId == selectedUserId);

            if (existingAssignment != null)
            {
                if (existingAssignment.IsActive)
                {
                    // ƒê√£ ƒë∆∞·ª£c g√°n v√† active
                    await JS.InvokeVoidAsync("alert", "Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c g√°n cho thi·∫øt b·ªã n√†y r·ªìi.");
                    return;
                }
                else
                {
                    // ƒê√£ ƒë∆∞·ª£c g√°n nh∆∞ng b·ªã remove - t√°i k√≠ch ho·∫°t
                    existingAssignment.IsActive = true;
                    existingAssignment.AssignedAt = DateTime.UtcNow;
                    context.DeviceUserAssignments.Update(existingAssignment);
                }
            }
            else
            {
                // T·∫°o m·ªõi assignment
                var assignment = new DeviceUserAssignmentModel
                {
                    DeviceId = selectedApprovedDevice.DeviceId,
                    UserId = selectedUserId,
                    IsActive = true,
                    AssignedAt = DateTime.UtcNow
                };

                context.DeviceUserAssignments.Add(assignment);
            }

            await context.SaveChangesAsync();

            await ShowEditModal(selectedApprovedDevice);
            await JS.InvokeVoidAsync("alert", "Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c g√°n cho thi·∫øt b·ªã.");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"L·ªói: {ex.Message}");
        }
    }

    private async Task RemoveUserAssignment(string userId)
    {
        if (selectedApprovedDevice == null)
            return;

        if (await JS.InvokeAsync<bool>("confirm", "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a g√°n n√†y?"))
        {
            try
            {
                await using var context = DbContextFactory.CreateDbContext();

                var assignment = await context.DeviceUserAssignments
                .FirstOrDefaultAsync(a => a.DeviceId == selectedApprovedDevice.DeviceId && a.UserId == userId);

                if (assignment != null)
                {
                    assignment.IsActive = false;
                    context.DeviceUserAssignments.Update(assignment);
                    await context.SaveChangesAsync();

                    // üî• Force logout user b·ªã remove kh·ªèi device
                    await DeviceAuthService.NotifyUserRemovedFromDeviceAsync(selectedApprovedDevice.DeviceId, userId);
                    Logger.LogWarning($"[RemoveUserAssignment] User {userId} removed from device {selectedApprovedDevice.DeviceId}. Force logout triggered.");

                    // Ki·ªÉm tra xem user hi·ªán t·∫°i c√≥ ƒëang b·ªã remove kh√¥ng
                    var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                    var currentUserId = authState.User?.FindFirst("sub")?.Value;

                    if (currentUserId == userId)
                    {
                        // N·∫øu ƒë√≥ l√† user hi·ªán t·∫°i, s·∫Ω b·ªã logout b·ªüi timer check
                        await JS.InvokeVoidAsync("alert", "B·∫°n ƒë√£ b·ªã remove kh·ªèi thi·∫øt b·ªã n√†y. B·∫°n s·∫Ω b·ªã logout.");
                        // Timer s·∫Ω t·ª± ƒë·ªông detect v√† logout
                    }
                    else
                    {
                        await ShowEditModal(selectedApprovedDevice);
                        await JS.InvokeVoidAsync("alert", "Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi thi·∫øt b·ªã v√† b·ªã force logout.");
                    }
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"L·ªói: {ex.Message}");
            }
        }
    }

    private string GetText(string key, string defaultValue)
    {
        // TODO: Implement localization from service
        return defaultValue;
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        _accessCheckTimer?.Dispose();
        await ValueTask.CompletedTask;
    }
}