@inherits LayoutComponentBase
@implements IDisposable
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Routing
@using StationCheck.Services
@using StationCheck.Data
@using Microsoft.EntityFrameworkCore
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject LocalizationStateService LocalizationState
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject HttpClient HttpClient
@inject IHttpContextAccessor HttpContextAccessor
@inject ILogger<SBAdminLayout> Logger
@inject IForceLogoutService ForceLogoutService

<AuthorizeView>
    <Authorized Context="authContext">
        <div id="wrapper">
            <!-- Sidebar -->
            <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
                <!-- Sidebar - Brand -->
                <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/">
                    <div class="sidebar-brand-icon rotate-n-15">
                        <i class="fas fa-water"></i>
                    </div>
                    <div class="sidebar-brand-text mx-3">StationCheck</div>
                </a>

                @* Tạm thời ẩn Dashboard và divider *@
                <!-- Nav Item - Dashboard -->
                <AuthorizeView Roles="hidden">
                    <!-- Divider -->
                    <hr class="sidebar-divider my-0">

                    <li class="nav-item @(IsActive("/") ? "active" : "")">
                        <NavLink class="nav-link" href="/" Match="NavLinkMatch.All">
                            <i class="fas fa-fw fa-tachometer-alt"></i>
                            <span>@GetText("menu.dashboard", "Dashboard")</span>
                        </NavLink>
                    </li>
                </AuthorizeView>

                <!-- Divider & Heading for Management (Admin & Manager) -->
                <AuthorizeView Roles="Admin,Manager,StationEmployee">
                    <hr class="sidebar-divider">
                    <div class="sidebar-heading">
                        @GetText("menu.management", "Quản lý")
                    </div>
                </AuthorizeView>

                <!-- Nav Item - Stations (Admin & Manager) -->
                <AuthorizeView Roles="Admin,Manager,StationEmployee">
                    <li class="nav-item @(IsActive("/stations") ? "active" : "")">
                        <NavLink class="nav-link" href="/stations">
                            <i class="fas fa-fw fa-building"></i>
                            <span>@GetText("menu.stations", "Quản lý Trạm")</span>
                        </NavLink>
                    </li>
                </AuthorizeView>

                <!-- Nav Item - My Station (StationEmployee Only) -->
                <AuthorizeView Roles="hidden">
                    <li class="nav-item @(IsActive("/my-station") ? "active" : "")">
                        <NavLink class="nav-link" href="/my-station">
                            <i class="fas fa-fw fa-building"></i>
                            <span>@GetText("menu.my_station", "Trạm của tôi")</span>
                        </NavLink>
                    </li>
                </AuthorizeView>

                @* <!-- Nav Item - Motion Monitoring (Manager & Admin) -->
                <AuthorizeView Roles="Admin,Manager">
                    <li class="nav-item @(IsActive("/motion-monitoring") ? "active" : "")">
                        <NavLink class="nav-link" href="/motion-monitoring">
                            <i class="fas fa-fw fa-video"></i>
                            <span>@GetText("menu.motion_monitoring", "Giám sát nhấn nút")</span>
                        </NavLink>
                    </li>
                </AuthorizeView> *@


                @* <!-- Nav Item - Time Schedules (Manager & Admin) -->
                <AuthorizeView Roles="Admin,Manager">
                    <li class="nav-item @(IsActive("/schedules") ? "active" : "")">
                        <NavLink class="nav-link" href="/schedules">
                            <i class="fas fa-fw fa-clock"></i>
                            <span>@GetText("menu.schedules", "Cấu hình Lịch")</span>
                        </NavLink>
                    </li>
                </AuthorizeView> *@

                <!-- Divider & Heading for Monitoring (Admin & Manager) -->
                <AuthorizeView Roles="Admin,Manager,StationEmployee">
                    <hr class="sidebar-divider">
                    <div class="sidebar-heading">
                        @GetText("menu.monitoring", defaultText: "Giám sát")
                    </div>
                </AuthorizeView>
                @* 
                <!-- Nav Item - Monitoring Settings (Admin Only) -->
                <AuthorizeView Roles="Admin">
                    <li class="nav-item @(IsActive("/monitoring/settings") ? "active" : "")">
                        <NavLink class="nav-link" href="/monitoring/settings">
                            <i class="fas fa-fw fa-toggle-on"></i>
                            <span>@GetText("menu.monitoring_settings", "Cấu hình Giám sát")</span>
                        </NavLink>
                    </li>
                </AuthorizeView> *@
                @* 
                <!-- Nav Item - Monitoring Profiles (Admin Only) -->
                <AuthorizeView Roles="Admin">
                    <li class="nav-item @(IsActive("/monitoring/profiles") ? "active" : "")">
                        <NavLink class="nav-link" href="/monitoring/profiles">
                            <i class="fas fa-fw fa-calendar-alt"></i>
                            <span>@GetText("menu.monitoring_profiles", "Profile Giám sát")</span>
                        </NavLink>
                    </li>
                </AuthorizeView> *@



                <!-- Nav Item - Station Monitor (Real-time Status) -->
                <AuthorizeView Roles="Admin,Manager,StationEmployee">
                    <li class="nav-item @(IsActive("/station-monitor") ? "active" : "")">
                        <NavLink class="nav-link" href="/station-monitor">
                            <i class="fas fa-fw fa-broadcast-tower"></i>
                            <span>@GetText("menu.station_monitor", "Trạng thái Trạm")</span>
                        </NavLink>
                    </li>
                </AuthorizeView>

                <!-- Nav Item - Reports (Admin & Manager) -->
                <AuthorizeView Roles="Admin,Manager">
                    <li class="nav-item @(IsActive("/reports") ? "active" : "")">
                        <NavLink class="nav-link" href="/reports">
                            <i class="fas fa-fw fa-chart-bar"></i>
                            <span>@GetText("menu.reports", "Báo cáo")</span>
                        </NavLink>
                    </li>
                </AuthorizeView>

                <!-- Nav Item - System Configuration (Admin Only) -->
                <AuthorizeView Roles="hidden">
                    <li class="nav-item @(IsActive("/email-simulator") ? "active" : "")">
                        <NavLink class="nav-link" href="/email-simulator">
                            <i class="fas fa-fw fa-cogs"></i>
                            <span>@GetText("menu.email_simulator", "Test Email")</span>
                        </NavLink>
                    </li>
                </AuthorizeView>


                <!-- Divider & Heading for Personnel (Admin Only) -->
                <AuthorizeView Roles="Admin,Manager">
                    <hr class="sidebar-divider">
                    <div class="sidebar-heading">
                        @GetText("menu.personnel", "Nhân sự")
                    </div>
                </AuthorizeView>




                <!-- Nav Item - Employees (Manager & Admin) -->
                @* <AuthorizeView Roles="Admin,Manager">
                    <li class="nav-item @(IsActive("/employees") ? "active" : "")">
                        <NavLink class="nav-link" href="/employees">
                            <i class="fas fa-fw fa-users"></i>
                            <span>@GetText("menu.employees", "Nhân viên")</span>
                        </NavLink>
                    </li>
                </AuthorizeView> *@

                <!-- Nav Item - Users (Manager & Admin) -->
                <AuthorizeView Roles="Admin">
                    <li class="nav-item @(IsActive("/users") ? "active" : "")">
                        <NavLink class="nav-link" href="/users">
                            <i class="fas fa-fw fa-user-cog"></i>
                            <span>@GetText("menu.users", "Quản lý User")</span>
                        </NavLink>
                    </li>


                </AuthorizeView>

                <AuthorizeView Roles="Admin,Manager">

                    <li class="nav-item @(IsActive("/device-management") ? "active" : "")">
                        <NavLink class="nav-link" href="/device-management">
                            <i class="fas fa-fw fa-tablet-alt"></i>
                            <span>@GetText("menu.device_management", "Quản lý thiết bị")</span>
                        </NavLink>
                    </li>
                </AuthorizeView>

                <!-- Divider & Heading for System (Admin Only) -->
                <AuthorizeView Roles="Admin">
                    <hr class="sidebar-divider">
                    <div class="sidebar-heading">
                        @GetText("menu.system", "Hệ thống")
                    </div>
                </AuthorizeView>

                <!-- Nav Item - Languages (Admin Only) -->
                <AuthorizeView Roles="Admin">
                    <li class="nav-item @(IsActive("/languages") ? "active" : "")">
                        <NavLink class="nav-link" href="/languages">
                            <i class="fas fa-fw fa-language"></i>
                            <span>@GetText("menu.languages", "Ngôn ngữ")</span>
                        </NavLink>
                    </li>
                </AuthorizeView>

                <!-- Nav Item - Translations (Admin Only) -->
                <AuthorizeView Roles="Admin">
                    <li class="nav-item @(IsActive("/translations") ? "active" : "")">
                        <NavLink class="nav-link" href="/translations">
                            <i class="fas fa-fw fa-globe"></i>
                            <span>@GetText("menu.translations", "Bản dịch")</span>
                        </NavLink>
                    </li>
                </AuthorizeView>


                <!-- Nav Item - System Configuration (Admin Only) -->
                <AuthorizeView Roles="Admin">
                    <li class="nav-item @(IsActive("/system-config") ? "active" : "")">
                        <NavLink class="nav-link" href="/system-config">
                            <i class="fas fa-fw fa-cogs"></i>
                            <span>@GetText("menu.system_config", "Cấu hình Hệ thống")</span>
                        </NavLink>
                    </li>
                </AuthorizeView>

                <!-- Divider -->
                <hr class="sidebar-divider d-none d-md-block">

                <!-- Sidebar Toggler (Sidebar) -->
                <div class="text-center d-none d-md-inline">
                    <button class="rounded-circle border-0" id="sidebarToggle"></button>
                </div>
            </ul>
            <!-- End of Sidebar -->

            <!-- Content Wrapper -->
            <div id="content-wrapper" class="d-flex flex-column">
                <!-- Main Content -->
                <div id="content">
                    <!-- Topbar -->
                    <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow header-layout">
                        <!-- Sidebar Toggle (Topbar) -->
                        <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                            <i class="fa fa-bars"></i>
                        </button>

                        <!-- Topbar Navbar -->
                        <ul class="navbar-nav ml-auto">
                            <!-- Nav Item - Language Switcher -->
                            <li class="nav-item dropdown no-arrow mx-1">
                                <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="fas fa-globe fa-fw"></i>
                                    <span class="d-none d-lg-inline ml-1">@GetCurrentLanguageName()</span>
                                </a>
                                <!-- Dropdown - Language Selection -->
                                <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                    aria-labelledby="languageDropdown">
                                    <a class="dropdown-item @(LocalizationState?.CurrentLanguage == "vi" ? "active" : "")"
                                        href="#" @onclick="@(() => ChangeLanguage("vi"))" @onclick:preventDefault>
                                        <i class="fas fa-flag fa-sm fa-fw mr-2"></i>
                                        Tiếng Việt
                                    </a>
                                    <a class="dropdown-item @(LocalizationState?.CurrentLanguage == "en" ? "active" : "")"
                                        href="#" @onclick="@(() => ChangeLanguage("en"))" @onclick:preventDefault>
                                        <i class="fas fa-flag fa-sm fa-fw mr-2"></i>
                                        English
                                    </a>
                                </div>
                            </li>

                            <!-- Nav Item - User Information -->
                            <li class="nav-item dropdown no-arrow">
                                <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span
                                        class="mr-2 d-none d-lg-inline text-gray-600 small">@authContext.User.Identity?.Name</span>
                                    <i class="fas fa-user-circle fa-2x text-gray-600"></i>
                                </a>
                                <!-- Dropdown - User Information -->
                                <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                    aria-labelledby="userDropdown">
                                    <a class="dropdown-item" href="/profile">
                                        <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                                        @GetText("menu.profile", "Profile")
                                    </a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="#" @onclick="Logout">
                                        <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                                        @GetText("menu.logout", "Logout")
                                    </a>
                                </div>
                            </li>
                        </ul>
                    </nav>
                    <!-- End of Topbar -->

                    <!-- Begin Page Content -->
                    <div class="container-fluid">
                        <CascadingAuthenticationState>
                            @Body
                        </CascadingAuthenticationState>
                    </div>
                    <!-- /.container-fluid -->
                </div>
                <!-- End of Main Content -->

                <!-- Footer -->
                <footer class="sticky-footer bg-white pt-1">
                    <div class="container my-auto p-2">
                        <div class="copyright text-center my-auto">
                            <span>Copyright &copy; StationCheck @DateTime.Now.Year</span>
                        </div>
                    </div>
                </footer>
                <!-- End of Footer -->
            </div>
            <!-- End of Content Wrapper -->
        </div>
        <!-- End of Page Wrapper -->

        <!-- Scroll to Top Button-->
        <a class="scroll-to-top rounded" href="#page-top">
            <i class="fas fa-angle-up"></i>
        </a>
    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>

@code {
    private string currentLanguage = "vi";
    private Timer? _accessCheckTimer;

    protected override async Task OnInitializedAsync()
    {
        // Initialize LocalizationState
        if (LocalizationState != null && !LocalizationState.IsLoaded)
        {
            var storedLanguage = await JS.InvokeAsync<string?>("localStorage.getItem", "preferredLanguage");
            var browserLanguage = await JS.InvokeAsync<string?>("eval", "navigator.language || navigator.userLanguage");
            var preferredLanguage = storedLanguage ?? (browserLanguage?.StartsWith("vi") == true ? "vi" : "en");

            await LocalizationState.InitializeAsync(preferredLanguage);
            currentLanguage = preferredLanguage;
        }

        // DISABLED: ForceLogoutService certificate checking (causes refresh loop for browser SSO)
        // Certificate-based device validation is handled by AccessControlMiddleware with MAC address
        // var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        // var user = authState.User;
        //
        // if (user?.Identity?.IsAuthenticated == true)
        // {
        //     Logger.LogInformation($"[SBAdminLayout] Starting ForceLogoutService timer for user: {user.Identity.Name}");
        //
        //     // Check immediately
        //     await CheckUserAccessAndLogoutIfNeeded();
        //
        //     // Then check every 5 seconds
        //     _accessCheckTimer = new Timer(async _ =>
        //     {
        //         await InvokeAsync(async () => await CheckUserAccessAndLogoutIfNeeded());
        //     }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
        // }
    }

    private async Task CheckUserAccessAndLogoutIfNeeded()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user?.Identity?.IsAuthenticated == true)
            {
                await ForceLogoutService.CheckAndLogoutIfNeededAsync(
                user,
                DbContextFactory,
                HttpClient,
                Navigation,
                JS,
                Logger,
                _accessCheckTimer,
                HttpContextAccessor
                );
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[SBAdminLayout] Error in CheckUserAccessAndLogoutIfNeeded");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Read current language from localStorage
                var storedLanguage = await JS.InvokeAsync<string?>("localStorage.getItem", "preferredLanguage");
                if (!string.IsNullOrEmpty(storedLanguage))
                {
                    currentLanguage = storedLanguage;
                    StateHasChanged();
                }
            }
            catch { }

            // Subscribe to language changes
            if (LocalizationState != null)
            {
                LocalizationState.OnLanguageChanged += HandleLanguageChanged;
            }

            // Wait for translations to load
            if (LocalizationState != null)
            {
                int attempts = 0;
                while (!LocalizationState.IsLoaded && attempts < 20)
                {
                    await Task.Delay(100);
                    attempts++;
                }

                if (LocalizationState.IsLoaded)
                {
                    StateHasChanged();
                }
            }

            // Initialize device status monitoring for real-time notifications
            try
            {
                var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                
                // Only initialize for authenticated StationEmployee users
                if (user?.Identity?.IsAuthenticated == true)
                {
                    var role = user.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value;
                    if (role == "StationEmployee")
                    {
                        await JS.InvokeVoidAsync("initDeviceStatusMonitor");
                        Logger.LogInformation("[SBAdminLayout] Device status monitoring initialized for user: {Username}", user.Identity.Name);
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "[SBAdminLayout] Failed to initialize device status monitoring");
            }
        }
    }

    private void HandleLanguageChanged()
    {
        currentLanguage = LocalizationState?.CurrentLanguage ?? "vi";
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        if (LocalizationState != null)
        {
            LocalizationState.OnLanguageChanged -= HandleLanguageChanged;
        }

        // Clean up ForceLogoutService timer
        _accessCheckTimer?.Dispose();
        _accessCheckTimer = null;
    }

    private bool IsActive(string href)
    {
        var currentPath = new Uri(Navigation.Uri).AbsolutePath;
        return currentPath.Equals(href, StringComparison.OrdinalIgnoreCase);
    }

    private async Task Logout()
    {
        // Don't call logout API if already on login page
        var currentPath = new Uri(Navigation.Uri).AbsolutePath;
        if (currentPath != "/login")
        {
            try
            {
                // ✅ Use JavaScript fetch to logout (handles cookies, storage, and redirect)
                // JavaScript will do full page reload to clear Blazor circuit state
                await JS.InvokeVoidAsync("logoutWithFetch");
                // No need to call Navigation.NavigateTo - JavaScript handles redirect
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[Logout] Error: {ex.Message}");
                // Fallback: Force reload to login if JavaScript fails
                Navigation.NavigateTo("/login", forceLoad: true);
            }
        }
        else
        {
            // Already on login page, just reload
            Navigation.NavigateTo("/login", forceLoad: true);
        }
    }

    private string GetText(string key, string defaultText)
    {
        return LocalizationState?.GetText(key, defaultText) ?? defaultText;
    }

    private string GetCurrentLanguageName()
    {
        return currentLanguage switch
        {
            "vi" => "Tiếng Việt",
            "en" => "English",
            _ => "Language"
        };
    }

    private async Task ChangeLanguage(string languageCode)
    {
        if (LocalizationState != null)
        {
            // Save to localStorage
            try
            {
                await JS.InvokeVoidAsync("localStorage.setItem", "preferredLanguage", languageCode);
            }
            catch { }

            // Update state
            await LocalizationState.SetLanguageAsync(languageCode);

            // Reload page to apply translations
            Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
        }
    }
}